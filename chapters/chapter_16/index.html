<!DOCTYPE html><html lang="en" dir="ltr" data-has-toc data-has-sidebar class="astro-fpze62lo"> <head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title>错误处理进阶(Advanced Error handling) | Cookbook for Rustaceans in Finance / Rust 量化金融开发指南</title><link rel="canonical"/><link rel="shortcut icon" href="/favicon.svg" type="image/svg+xml"/><meta name="generator" content="Astro v4.3.3"/><meta name="generator" content="Starlight v0.17.3"/><meta property="og:title" content="错误处理进阶(Advanced Error handling)"/><meta property="og:type" content="article"/><meta property="og:url"/><meta property="og:locale" content="en"/><meta property="og:description"/><meta property="og:site_name" content="Cookbook for Rustaceans in Finance / Rust 量化金融开发指南"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:title" content="错误处理进阶(Advanced Error handling)"/><meta name="twitter:description"/><script>
	window.StarlightThemeProvider = (() => {
		const storedTheme =
			typeof localStorage !== 'undefined' && localStorage.getItem('starlight-theme');
		const theme =
			storedTheme ||
			(window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');
		document.documentElement.dataset.theme = theme === 'light' ? 'light' : 'dark';
		return {
			updatePickers(theme = storedTheme || 'auto') {
				document.querySelectorAll('starlight-theme-select').forEach((picker) => {
					const select = picker.querySelector('select');
					if (select) select.value = theme;
					/** @type {HTMLTemplateElement | null} */
					const tmpl = document.querySelector(`#theme-icons`);
					const newIcon = tmpl && tmpl.content.querySelector('.' + theme);
					if (newIcon) {
						const oldIcon = picker.querySelector('svg.label-icon');
						if (oldIcon) {
							oldIcon.replaceChildren(...newIcon.cloneNode(true).childNodes);
						}
					}
				});
			},
		};
	})();
</script><template id="theme-icons"><svg aria-hidden="true" class="light astro-xrndq6a6" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M5 12a1 1 0 0 0-1-1H3a1 1 0 0 0 0 2h1a1 1 0 0 0 1-1Zm.64 5-.71.71a1 1 0 0 0 0 1.41 1 1 0 0 0 1.41 0l.71-.71A1 1 0 0 0 5.64 17ZM12 5a1 1 0 0 0 1-1V3a1 1 0 0 0-2 0v1a1 1 0 0 0 1 1Zm5.66 2.34a1 1 0 0 0 .7-.29l.71-.71a1 1 0 1 0-1.41-1.41l-.66.71a1 1 0 0 0 0 1.41 1 1 0 0 0 .66.29Zm-12-.29a1 1 0 0 0 1.41 0 1 1 0 0 0 0-1.41l-.71-.71a1.004 1.004 0 1 0-1.43 1.41l.73.71ZM21 11h-1a1 1 0 0 0 0 2h1a1 1 0 0 0 0-2Zm-2.64 6A1 1 0 0 0 17 18.36l.71.71a1 1 0 0 0 1.41 0 1 1 0 0 0 0-1.41l-.76-.66ZM12 6.5a5.5 5.5 0 1 0 5.5 5.5A5.51 5.51 0 0 0 12 6.5Zm0 9a3.5 3.5 0 1 1 0-7 3.5 3.5 0 0 1 0 7Zm0 3.5a1 1 0 0 0-1 1v1a1 1 0 0 0 2 0v-1a1 1 0 0 0-1-1Z"/></svg> <svg aria-hidden="true" class="dark astro-xrndq6a6" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M21.64 13a1 1 0 0 0-1.05-.14 8.049 8.049 0 0 1-3.37.73 8.15 8.15 0 0 1-8.14-8.1 8.59 8.59 0 0 1 .25-2A1 1 0 0 0 8 2.36a10.14 10.14 0 1 0 14 11.69 1 1 0 0 0-.36-1.05Zm-9.5 6.69A8.14 8.14 0 0 1 7.08 5.22v.27a10.15 10.15 0 0 0 10.14 10.14 9.784 9.784 0 0 0 2.1-.22 8.11 8.11 0 0 1-7.18 4.32v-.04Z"/></svg> <svg aria-hidden="true" class="auto astro-xrndq6a6" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M21 14h-1V7a3 3 0 0 0-3-3H7a3 3 0 0 0-3 3v7H3a1 1 0 0 0-1 1v2a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3v-2a1 1 0 0 0-1-1ZM6 7a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v7H6V7Zm14 10a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-1h16v1Z"/></svg> </template><link rel="stylesheet" href="/_astro/index.4lckRRHb.css" /><script type="module" src="/_astro/hoisted.RLbdawI7.js"></script>
<script type="module" src="/_astro/page.X_0NJa-z.js"></script></head> <body class="astro-fpze62lo"> <a href="#_top" class="astro-byjsuuaw">Skip to content</a>  <div class="page sl-flex astro-yxqmbg7i"> <header class="header astro-yxqmbg7i"><div class="header sl-flex astro-cyrhhlnw"> <div class="title-wrapper sl-flex astro-cyrhhlnw"> <a href="/" class="site-title sl-flex astro-ylanx5mn">  <span class="astro-ylanx5mn"> Cookbook for Rustaceans in Finance / Rust 量化金融开发指南 </span> </a>  </div> <div class="sl-flex astro-cyrhhlnw"> <site-search data-translations="{&#34;placeholder&#34;:&#34;Search&#34;}" class="astro-usz5hgcn"> <button data-open-modal disabled class="astro-usz5hgcn">  <svg aria-label="Search" class="astro-usz5hgcn astro-xrndq6a6" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M21.71 20.29 18 16.61A9 9 0 1 0 16.61 18l3.68 3.68a.999.999 0 0 0 1.42 0 1 1 0 0 0 0-1.39ZM11 18a7 7 0 1 1 0-14 7 7 0 0 1 0 14Z"/></svg>  <span class="sl-hidden md:sl-block astro-usz5hgcn" aria-hidden="true">Search</span> <svg aria-label="(Press / to Search)" class="sl-hidden md:sl-block astro-usz5hgcn astro-xrndq6a6" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M17 2H7a5 5 0 0 0-5 5v10a5 5 0 0 0 5 5h10a5 5 0 0 0 5-5V7a5 5 0 0 0-5-5Zm3 15a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V7a3 3 0 0 1 3-3h10a3 3 0 0 1 3 3v10Z"/><path d="M15.293 6.707a1 1 0 1 1 1.414 1.414l-8.485 8.486a1 1 0 0 1-1.414-1.415l8.485-8.485Z"/></svg>  </button> <dialog style="padding:0" aria-label="Search" class="astro-usz5hgcn"> <div class="dialog-frame sl-flex astro-usz5hgcn">  <button data-close-modal class="sl-flex md:sl-hidden astro-usz5hgcn"> Cancel </button> <div class="search-container astro-usz5hgcn"> <div id="starlight__search" class="astro-usz5hgcn"></div> </div> </div> </dialog> </site-search>    </div> <div class="sl-hidden md:sl-flex right-group astro-cyrhhlnw"> <div class="sl-flex social-icons astro-cyrhhlnw"> <a href="https://github.com/withastro/starlight" rel="me" class="sl-flex astro-3daxh4jc"><span class="sr-only astro-3daxh4jc">GitHub</span><svg aria-hidden="true" class="astro-3daxh4jc astro-xrndq6a6" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M12 .3a12 12 0 0 0-3.8 23.38c.6.12.83-.26.83-.57L9 21.07c-3.34.72-4.04-1.61-4.04-1.61-.55-1.39-1.34-1.76-1.34-1.76-1.08-.74.09-.73.09-.73 1.2.09 1.83 1.24 1.83 1.24 1.08 1.83 2.81 1.3 3.5 1 .1-.78.42-1.31.76-1.61-2.67-.3-5.47-1.33-5.47-5.93 0-1.31.47-2.38 1.24-3.22-.14-.3-.54-1.52.1-3.18 0 0 1-.32 3.3 1.23a11.5 11.5 0 0 1 6 0c2.28-1.55 3.29-1.23 3.29-1.23.64 1.66.24 2.88.12 3.18a4.65 4.65 0 0 1 1.23 3.22c0 4.61-2.8 5.63-5.48 5.92.42.36.81 1.1.81 2.22l-.01 3.29c0 .31.2.69.82.57A12 12 0 0 0 12 .3Z"/></svg> </a> </div> <starlight-theme-select>  <label style="--sl-select-width: 6.25em" class="astro-kc6u4lxd"> <span class="sr-only astro-kc6u4lxd">Select theme</span> <svg aria-hidden="true" class="icon label-icon astro-kc6u4lxd astro-xrndq6a6" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M21 14h-1V7a3 3 0 0 0-3-3H7a3 3 0 0 0-3 3v7H3a1 1 0 0 0-1 1v2a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3v-2a1 1 0 0 0-1-1ZM6 7a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v7H6V7Zm14 10a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-1h16v1Z"/></svg>  <select value="auto" class="astro-kc6u4lxd"> <option value="dark" class="astro-kc6u4lxd">Dark</option><option value="light" class="astro-kc6u4lxd">Light</option><option value="auto" selected="true" class="astro-kc6u4lxd">Auto</option> </select> <svg aria-hidden="true" class="icon caret astro-kc6u4lxd astro-xrndq6a6" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M17 9.17a1 1 0 0 0-1.41 0L12 12.71 8.46 9.17a1 1 0 1 0-1.41 1.42l4.24 4.24a1.002 1.002 0 0 0 1.42 0L17 10.59a1.002 1.002 0 0 0 0-1.42Z"/></svg>  </label>  </starlight-theme-select>  <script>
	StarlightThemeProvider.updatePickers();
</script>   </div> </div> </header> <nav class="sidebar astro-yxqmbg7i" aria-label="Main"> <starlight-menu-button class="astro-eouth4v3"> <button aria-expanded="false" aria-label="Menu" aria-controls="starlight__sidebar" class="sl-flex md:sl-hidden astro-eouth4v3"> <svg aria-hidden="true" class="astro-eouth4v3 astro-xrndq6a6" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M3 8h18a1 1 0 1 0 0-2H3a1 1 0 0 0 0 2Zm18 8H3a1 1 0 0 0 0 2h18a1 1 0 0 0 0-2Zm0-5H3a1 1 0 0 0 0 2h18a1 1 0 0 0 0-2Z"/></svg>  </button> </starlight-menu-button>    <div id="starlight__sidebar" class="sidebar-pane astro-yxqmbg7i"> <div class="sidebar-content sl-flex astro-yxqmbg7i"> <ul class="top-level astro-4mcqxzkb"> <li class="astro-4mcqxzkb"> <details open class="astro-4mcqxzkb"> <summary class="astro-4mcqxzkb"> <div class="group-label astro-4mcqxzkb"> <span class="large astro-4mcqxzkb">PART I 基础部分 - 量化语境下的Rust编程基础</span>  </div> <svg aria-hidden="true" class="caret astro-4mcqxzkb astro-xrndq6a6" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1.25rem;"><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg>  </summary> <ul class="astro-4mcqxzkb"> <li class="astro-4mcqxzkb"> <a href="/chapters/chapter_1" class="astro-4mcqxzkb"> <span class="astro-4mcqxzkb">1. Rust 语言入门101</span>  </a> </li><li class="astro-4mcqxzkb"> <a href="/chapters/chapter_2/" class="astro-4mcqxzkb"> <span class="astro-4mcqxzkb">2. 格式化输出</span>  </a> </li><li class="astro-4mcqxzkb"> <a href="/chapters/chapter_3/" class="astro-4mcqxzkb"> <span class="astro-4mcqxzkb">3. 原生类型</span>  </a> </li><li class="astro-4mcqxzkb"> <a href="/chapters/chapter_4/" class="astro-4mcqxzkb"> <span class="astro-4mcqxzkb">4. 自定义类型 Struct &amp; Enum</span>  </a> </li><li class="astro-4mcqxzkb"> <a href="/chapters/chapter_5/" class="astro-4mcqxzkb"> <span class="astro-4mcqxzkb">5. 标准库类型</span>  </a> </li><li class="astro-4mcqxzkb"> <a href="/chapters/chapter_6/" class="astro-4mcqxzkb"> <span class="astro-4mcqxzkb">6. 变量和作用域</span>  </a> </li><li class="astro-4mcqxzkb"> <a href="/chapters/chapter_7/" class="astro-4mcqxzkb"> <span class="astro-4mcqxzkb">7. 类型系统</span>  </a> </li><li class="astro-4mcqxzkb"> <a href="/chapters/chapter_8/" class="astro-4mcqxzkb"> <span class="astro-4mcqxzkb">8. 类型转换</span>  </a> </li><li class="astro-4mcqxzkb"> <a href="/chapters/chapter_9/" class="astro-4mcqxzkb"> <span class="astro-4mcqxzkb">9. 流程控制</span>  </a> </li><li class="astro-4mcqxzkb"> <a href="/chapters/chapter_10/" class="astro-4mcqxzkb"> <span class="astro-4mcqxzkb">10. 函数、方法和闭包</span>  </a> </li><li class="astro-4mcqxzkb"> <a href="/chapters/chapter_11/" class="astro-4mcqxzkb"> <span class="astro-4mcqxzkb">11. 模块</span>  </a> </li><li class="astro-4mcqxzkb"> <a href="/chapters/chapter_12/" class="astro-4mcqxzkb"> <span class="astro-4mcqxzkb">12. Cargo 的进阶使用</span>  </a> </li><li class="astro-4mcqxzkb"> <a href="/chapters/chapter_13/" class="astro-4mcqxzkb"> <span class="astro-4mcqxzkb">13. 属性(Attributes)</span>  </a> </li><li class="astro-4mcqxzkb"> <a href="/chapters/chapter_14/" class="astro-4mcqxzkb"> <span class="astro-4mcqxzkb">14. 泛型进阶(Advanced Generic Type Usage)</span>  </a> </li><li class="astro-4mcqxzkb"> <a href="/chapters/chapter_15/" class="astro-4mcqxzkb"> <span class="astro-4mcqxzkb">15. 作用域规则和生命周期</span>  </a> </li><li class="astro-4mcqxzkb"> <a href="/chapters/chapter_16/" aria-current="page" class="astro-4mcqxzkb"> <span class="astro-4mcqxzkb">16. 错误处理进阶(Advanced Error handling)</span>  </a> </li><li class="astro-4mcqxzkb"> <a href="/chapters/chapter_17/" class="astro-4mcqxzkb"> <span class="astro-4mcqxzkb">17. 特性(trait)详解</span>  </a> </li><li class="astro-4mcqxzkb"> <a href="/chapters/chapter_18/" class="astro-4mcqxzkb"> <span class="astro-4mcqxzkb">18. 创建自定义宏</span>  </a> </li><li class="astro-4mcqxzkb"> <a href="/chapters/chapter_19/" class="astro-4mcqxzkb"> <span class="astro-4mcqxzkb">19. 时间处理</span>  </a> </li><li class="astro-4mcqxzkb"> <a href="/chapters/chapter_20/" class="astro-4mcqxzkb"> <span class="astro-4mcqxzkb">20. Redis、爬虫、交易日库</span>  </a> </li><li class="astro-4mcqxzkb"> <a href="/chapters/chapter_21/" class="astro-4mcqxzkb"> <span class="astro-4mcqxzkb">21. 线程和管道</span>  </a> </li><li class="astro-4mcqxzkb"> <a href="/chapters/chapter_22/" class="astro-4mcqxzkb"> <span class="astro-4mcqxzkb">22. 文件处理</span>  </a> </li> </ul>  </details> </li><li class="astro-4mcqxzkb"> <details open class="astro-4mcqxzkb"> <summary class="astro-4mcqxzkb"> <div class="group-label astro-4mcqxzkb"> <span class="large astro-4mcqxzkb">PART II 进阶部分 - 量化实战</span>  </div> <svg aria-hidden="true" class="caret astro-4mcqxzkb astro-xrndq6a6" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1.25rem;"><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg>  </summary> <ul class="astro-4mcqxzkb"> <li class="astro-4mcqxzkb"> <a href="/chapters/chapter_23/" class="astro-4mcqxzkb"> <span class="astro-4mcqxzkb">23. Polars 入门</span>  </a> </li><li class="astro-4mcqxzkb"> <a href="/chapters/chapter_24/" class="astro-4mcqxzkb"> <span class="astro-4mcqxzkb">24. 时序数据库 Clickhouse</span>  </a> </li><li class="astro-4mcqxzkb"> <a href="/chapters/chapter_25/" class="astro-4mcqxzkb"> <span class="astro-4mcqxzkb">25. Unsafe【未完成】</span>  </a> </li><li class="astro-4mcqxzkb"> <a href="/chapters/chapter_26/" class="astro-4mcqxzkb"> <span class="astro-4mcqxzkb">26. 文档和测试【未完成】</span>  </a> </li><li class="astro-4mcqxzkb"> <a href="/chapters/chapter_27/" class="astro-4mcqxzkb"> <span class="astro-4mcqxzkb">27. 常见技术指标及其实现【本章代码未添加】</span>  </a> </li><li class="astro-4mcqxzkb"> <a href="/chapters/chapter_28/" class="astro-4mcqxzkb"> <span class="astro-4mcqxzkb">28. 统计模型【未完成】</span>  </a> </li><li class="astro-4mcqxzkb"> <a href="/chapters/chapter_29/" class="astro-4mcqxzkb"> <span class="astro-4mcqxzkb">29. 引擎系统【未完成】</span>  </a> </li><li class="astro-4mcqxzkb"> <a href="/chapters/chapter_30/" class="astro-4mcqxzkb"> <span class="astro-4mcqxzkb">30. 日志系统【未完成】</span>  </a> </li><li class="astro-4mcqxzkb"> <a href="/chapters/chapter_31/" class="astro-4mcqxzkb"> <span class="astro-4mcqxzkb">31. 投资组合管理【未完成】</span>  </a> </li><li class="astro-4mcqxzkb"> <a href="/chapters/chapter_32/" class="astro-4mcqxzkb"> <span class="astro-4mcqxzkb">32. 量化计量经济学【未完成】</span>  </a> </li><li class="astro-4mcqxzkb"> <a href="/chapters/chapter_33/" class="astro-4mcqxzkb"> <span class="astro-4mcqxzkb">33. 限价指令簿【未完成】</span>  </a> </li><li class="astro-4mcqxzkb"> <a href="/chapters/chapter_34/" class="astro-4mcqxzkb"> <span class="astro-4mcqxzkb">34. 最优配置和执行【未完成】</span>  </a> </li><li class="astro-4mcqxzkb"> <a href="/chapters/chapter_35/" class="astro-4mcqxzkb"> <span class="astro-4mcqxzkb">35. 信息学、监管、风控【未完成】</span>  </a> </li><li class="astro-4mcqxzkb"> <a href="/chapters/chapter_36/" class="astro-4mcqxzkb"> <span class="astro-4mcqxzkb">36. 机器学习【未完成】</span>  </a> </li> </ul>  </details> </li> </ul>  <div class="md:sl-hidden"> <div class="mobile-preferences sl-flex astro-vfur2aw5"> <div class="sl-flex social-icons astro-vfur2aw5"> <a href="https://github.com/withastro/starlight" rel="me" class="sl-flex astro-3daxh4jc"><span class="sr-only astro-3daxh4jc">GitHub</span><svg aria-hidden="true" class="astro-3daxh4jc astro-xrndq6a6" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M12 .3a12 12 0 0 0-3.8 23.38c.6.12.83-.26.83-.57L9 21.07c-3.34.72-4.04-1.61-4.04-1.61-.55-1.39-1.34-1.76-1.34-1.76-1.08-.74.09-.73.09-.73 1.2.09 1.83 1.24 1.83 1.24 1.08 1.83 2.81 1.3 3.5 1 .1-.78.42-1.31.76-1.61-2.67-.3-5.47-1.33-5.47-5.93 0-1.31.47-2.38 1.24-3.22-.14-.3-.54-1.52.1-3.18 0 0 1-.32 3.3 1.23a11.5 11.5 0 0 1 6 0c2.28-1.55 3.29-1.23 3.29-1.23.64 1.66.24 2.88.12 3.18a4.65 4.65 0 0 1 1.23 3.22c0 4.61-2.8 5.63-5.48 5.92.42.36.81 1.1.81 2.22l-.01 3.29c0 .31.2.69.82.57A12 12 0 0 0 12 .3Z"/></svg> </a> </div> <starlight-theme-select>  <label style="--sl-select-width: 6.25em" class="astro-kc6u4lxd"> <span class="sr-only astro-kc6u4lxd">Select theme</span> <svg aria-hidden="true" class="icon label-icon astro-kc6u4lxd astro-xrndq6a6" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M21 14h-1V7a3 3 0 0 0-3-3H7a3 3 0 0 0-3 3v7H3a1 1 0 0 0-1 1v2a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3v-2a1 1 0 0 0-1-1ZM6 7a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v7H6V7Zm14 10a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-1h16v1Z"/></svg>  <select value="auto" class="astro-kc6u4lxd"> <option value="dark" class="astro-kc6u4lxd">Dark</option><option value="light" class="astro-kc6u4lxd">Light</option><option value="auto" selected="true" class="astro-kc6u4lxd">Auto</option> </select> <svg aria-hidden="true" class="icon caret astro-kc6u4lxd astro-xrndq6a6" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M17 9.17a1 1 0 0 0-1.41 0L12 12.71 8.46 9.17a1 1 0 1 0-1.41 1.42l4.24 4.24a1.002 1.002 0 0 0 1.42 0L17 10.59a1.002 1.002 0 0 0 0-1.42Z"/></svg>  </label>  </starlight-theme-select>  <script>
	StarlightThemeProvider.updatePickers();
</script>   </div>  </div> </div> </div> </nav> <div class="main-frame astro-yxqmbg7i">  <div class="lg:sl-flex astro-3vvvt7cz"> <aside class="right-sidebar-container astro-3vvvt7cz"> <div class="right-sidebar astro-3vvvt7cz"> <div class="lg:sl-hidden astro-f63w33c6"><mobile-starlight-toc data-min-h="2" data-max-h="3" class="astro-q2mrqdva"><nav aria-labelledby="starlight__on-this-page--mobile" class="astro-q2mrqdva"><details id="starlight__mobile-toc" class="astro-q2mrqdva"><summary id="starlight__on-this-page--mobile" class="sl-flex astro-q2mrqdva"><div class="toggle sl-flex astro-q2mrqdva">On this page<svg aria-hidden="true" class="caret astro-q2mrqdva astro-xrndq6a6" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1rem;"><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg> </div><span class="display-current astro-q2mrqdva"></span></summary><div class="dropdown astro-q2mrqdva"><ul class="isMobile astro-acifyk5h" style="--depth: 0;"> <li class="astro-acifyk5h" style="--depth: 0;"> <a href="#_top" class="astro-acifyk5h" style="--depth: 0;"> <span class="astro-acifyk5h" style="--depth: 0;">Overview</span> </a>  </li><li class="astro-acifyk5h" style="--depth: 0;"> <a href="#161-自定义错误类型" class="astro-acifyk5h" style="--depth: 0;"> <span class="astro-acifyk5h" style="--depth: 0;">16.1 自定义错误类型</span> </a>  </li><li class="astro-acifyk5h" style="--depth: 0;"> <a href="#162-错误链" class="astro-acifyk5h" style="--depth: 0;"> <span class="astro-acifyk5h" style="--depth: 0;">16.2 错误链</span> </a> <ul class="isMobile astro-acifyk5h" style="--depth: 1;"> <li class="astro-acifyk5h" style="--depth: 1;"> <a href="#补充学习-foo-和-bar" class="astro-acifyk5h" style="--depth: 1;"> <span class="astro-acifyk5h" style="--depth: 1;">补充学习： foo 和 bar</span> </a>  </li><li class="astro-acifyk5h" style="--depth: 1;"> <a href="#补充学习-source方法" class="astro-acifyk5h" style="--depth: 1;"> <span class="astro-acifyk5h" style="--depth: 1;">补充学习： source方法</span> </a>  </li> </ul>  </li><li class="astro-acifyk5h" style="--depth: 0;"> <a href="#163-错误处理宏" class="astro-acifyk5h" style="--depth: 0;"> <span class="astro-acifyk5h" style="--depth: 0;">16.3 错误处理宏</span> </a>  </li><li class="astro-acifyk5h" style="--depth: 0;"> <a href="#164-把错误装箱" class="astro-acifyk5h" style="--depth: 0;"> <span class="astro-acifyk5h" style="--depth: 0;">16.4 把错误“装箱”</span> </a>  </li><li class="astro-acifyk5h" style="--depth: 0;"> <a href="#165-用-map方法-处理-option链条-case-required" class="astro-acifyk5h" style="--depth: 0;"> <span class="astro-acifyk5h" style="--depth: 0;">16.5 用 map方法 处理 option链条 (case required)</span> </a>  </li><li class="astro-acifyk5h" style="--depth: 0;"> <a href="#166-and_then-方法" class="astro-acifyk5h" style="--depth: 0;"> <span class="astro-acifyk5h" style="--depth: 0;">16.6 and_then 方法</span> </a>  </li><li class="astro-acifyk5h" style="--depth: 0;"> <a href="#167-用filter_map-方法忽略空值" class="astro-acifyk5h" style="--depth: 0;"> <span class="astro-acifyk5h" style="--depth: 0;">16.7 用filter_map 方法忽略空值</span> </a> <ul class="isMobile astro-acifyk5h" style="--depth: 1;"> <li class="astro-acifyk5h" style="--depth: 1;"> <a href="#案例-数据清洗" class="astro-acifyk5h" style="--depth: 1;"> <span class="astro-acifyk5h" style="--depth: 1;">案例： 数据清洗</span> </a>  </li> </ul>  </li><li class="astro-acifyk5h" style="--depth: 0;"> <a href="#168-用collect-方法让整个操作链条失败" class="astro-acifyk5h" style="--depth: 0;"> <span class="astro-acifyk5h" style="--depth: 0;">16.8 用collect 方法让整个操作链条失败</span> </a> <ul class="isMobile astro-acifyk5h" style="--depth: 1;"> <li class="astro-acifyk5h" style="--depth: 1;"> <a href="#思考collect方法在金融领域有哪些用" class="astro-acifyk5h" style="--depth: 1;"> <span class="astro-acifyk5h" style="--depth: 1;">思考：collect方法在金融领域有哪些用？</span> </a>  </li><li class="astro-acifyk5h" style="--depth: 1;"> <a href="#案例与门逻辑的策略链条" class="astro-acifyk5h" style="--depth: 1;"> <span class="astro-acifyk5h" style="--depth: 1;">案例：“与门”逻辑的策略链条</span> </a>  </li> </ul>  </li> </ul> </div></details></nav></mobile-starlight-toc></div><div class="right-sidebar-panel sl-hidden lg:sl-block astro-f63w33c6"><div class="sl-container astro-f63w33c6"><starlight-toc data-min-h="2" data-max-h="3"><nav aria-labelledby="starlight__on-this-page"><h2 id="starlight__on-this-page">On this page</h2><ul class="astro-acifyk5h" style="--depth: 0;"> <li class="astro-acifyk5h" style="--depth: 0;"> <a href="#_top" class="astro-acifyk5h" style="--depth: 0;"> <span class="astro-acifyk5h" style="--depth: 0;">Overview</span> </a>  </li><li class="astro-acifyk5h" style="--depth: 0;"> <a href="#161-自定义错误类型" class="astro-acifyk5h" style="--depth: 0;"> <span class="astro-acifyk5h" style="--depth: 0;">16.1 自定义错误类型</span> </a>  </li><li class="astro-acifyk5h" style="--depth: 0;"> <a href="#162-错误链" class="astro-acifyk5h" style="--depth: 0;"> <span class="astro-acifyk5h" style="--depth: 0;">16.2 错误链</span> </a> <ul class="astro-acifyk5h" style="--depth: 1;"> <li class="astro-acifyk5h" style="--depth: 1;"> <a href="#补充学习-foo-和-bar" class="astro-acifyk5h" style="--depth: 1;"> <span class="astro-acifyk5h" style="--depth: 1;">补充学习： foo 和 bar</span> </a>  </li><li class="astro-acifyk5h" style="--depth: 1;"> <a href="#补充学习-source方法" class="astro-acifyk5h" style="--depth: 1;"> <span class="astro-acifyk5h" style="--depth: 1;">补充学习： source方法</span> </a>  </li> </ul>  </li><li class="astro-acifyk5h" style="--depth: 0;"> <a href="#163-错误处理宏" class="astro-acifyk5h" style="--depth: 0;"> <span class="astro-acifyk5h" style="--depth: 0;">16.3 错误处理宏</span> </a>  </li><li class="astro-acifyk5h" style="--depth: 0;"> <a href="#164-把错误装箱" class="astro-acifyk5h" style="--depth: 0;"> <span class="astro-acifyk5h" style="--depth: 0;">16.4 把错误“装箱”</span> </a>  </li><li class="astro-acifyk5h" style="--depth: 0;"> <a href="#165-用-map方法-处理-option链条-case-required" class="astro-acifyk5h" style="--depth: 0;"> <span class="astro-acifyk5h" style="--depth: 0;">16.5 用 map方法 处理 option链条 (case required)</span> </a>  </li><li class="astro-acifyk5h" style="--depth: 0;"> <a href="#166-and_then-方法" class="astro-acifyk5h" style="--depth: 0;"> <span class="astro-acifyk5h" style="--depth: 0;">16.6 and_then 方法</span> </a>  </li><li class="astro-acifyk5h" style="--depth: 0;"> <a href="#167-用filter_map-方法忽略空值" class="astro-acifyk5h" style="--depth: 0;"> <span class="astro-acifyk5h" style="--depth: 0;">16.7 用filter_map 方法忽略空值</span> </a> <ul class="astro-acifyk5h" style="--depth: 1;"> <li class="astro-acifyk5h" style="--depth: 1;"> <a href="#案例-数据清洗" class="astro-acifyk5h" style="--depth: 1;"> <span class="astro-acifyk5h" style="--depth: 1;">案例： 数据清洗</span> </a>  </li> </ul>  </li><li class="astro-acifyk5h" style="--depth: 0;"> <a href="#168-用collect-方法让整个操作链条失败" class="astro-acifyk5h" style="--depth: 0;"> <span class="astro-acifyk5h" style="--depth: 0;">16.8 用collect 方法让整个操作链条失败</span> </a> <ul class="astro-acifyk5h" style="--depth: 1;"> <li class="astro-acifyk5h" style="--depth: 1;"> <a href="#思考collect方法在金融领域有哪些用" class="astro-acifyk5h" style="--depth: 1;"> <span class="astro-acifyk5h" style="--depth: 1;">思考：collect方法在金融领域有哪些用？</span> </a>  </li><li class="astro-acifyk5h" style="--depth: 1;"> <a href="#案例与门逻辑的策略链条" class="astro-acifyk5h" style="--depth: 1;"> <span class="astro-acifyk5h" style="--depth: 1;">案例：“与门”逻辑的策略链条</span> </a>  </li> </ul>  </li> </ul> </nav></starlight-toc></div></div> </div> </aside> <div class="main-pane astro-3vvvt7cz">  <main data-pagefind-body lang="en" dir="ltr" class="astro-fpze62lo">    <div class="content-panel astro-vo2eo5fg"> <div class="sl-container astro-vo2eo5fg"> <h1 id="_top" class="astro-daoses2n">错误处理进阶(Advanced Error handling)</h1>  </div> </div>  <div class="content-panel astro-vo2eo5fg"> <div class="sl-container astro-vo2eo5fg"> <div class="sl-markdown-content"> <p>Rust 中的错误处理具有很高的灵活性和表现力。除了基本的错误处理机制（使用 <code dir="auto">Result</code> 和 <code dir="auto">Option</code>），Rust 还提供了一些高阶的错误处理技术，包括自定义错误类型、错误链、错误处理宏等。</p>
<p>以下是 Rust 中错误处理的一些高阶用法：</p>
<h2 id="161-自定义错误类型">16.1 自定义错误类型</h2>
<p>Rust 允许你创建自定义的错误类型，以便更好地表达你的错误情况。这通常涉及创建一个枚举，其中的变体表示不同的错误情况。你可以实现 <code dir="auto">std::error::Error</code> trait 来为自定义错误类型提供额外的信息。</p>
<div class="expressive-code"><link rel="stylesheet" href="/_astro/ec.usa2f.css"><script type="module" src="/_astro/ec.sgewm.js"></script><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#C792EA;--1:#8D46B4">use</span><span style="--0:#D6DEEB;--1:#403F53"> std</span><span style="--0:#7FDBCA;--1:#097174">::</span><span style="--0:#D6DEEB;--1:#403F53">error</span><span style="--0:#7FDBCA;--1:#097174">::</span><span style="--0:#D6DEEB;--1:#403F53">Error;</span></div><div class="ec-line"><span style="--0:#C792EA;--1:#8D46B4">use</span><span style="--0:#D6DEEB;--1:#403F53"> std</span><span style="--0:#7FDBCA;--1:#097174">::</span><span style="--0:#D6DEEB;--1:#403F53">fmt;</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#809191;--1:#5E6578">// 自定义错误类型</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">#[derive(Debug)]</span></div><div class="ec-line"><span style="--0:#C792EA;--1:#8D46B4">enum</span><span style="--0:#D6DEEB;--1:#403F53"> MyError {</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    </span><span style="--0:#82AAFF;--1:#3C63B3">IoError</span><span style="--0:#D6DEEB;--1:#403F53">(std</span><span style="--0:#7FDBCA;--1:#097174">::</span><span style="--0:#D6DEEB;--1:#403F53">io</span><span style="--0:#7FDBCA;--1:#097174">::</span><span style="--0:#D6DEEB;--1:#403F53">Error),</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    </span><span style="--0:#82AAFF;--1:#3C63B3">CustomError</span><span style="--0:#D6DEEB;--1:#403F53">(String),</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">}</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#809191;--1:#5E6578">// 实现 Error trait</span></div><div class="ec-line"><span style="--0:#C792EA;--1:#8D46B4">impl</span><span style="--0:#D6DEEB;--1:#403F53"> Error </span><span style="--0:#C792EA;--1:#8D46B4">for</span><span style="--0:#D6DEEB;--1:#403F53"> MyError {}</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#809191;--1:#5E6578">// 实现 Display trait 用于打印错误信息</span></div><div class="ec-line"><span style="--0:#C792EA;--1:#8D46B4">impl</span><span style="--0:#D6DEEB;--1:#403F53"> fmt</span><span style="--0:#7FDBCA;--1:#097174">::</span><span style="--0:#D6DEEB;--1:#403F53">Display </span><span style="--0:#C792EA;--1:#8D46B4">for</span><span style="--0:#D6DEEB;--1:#403F53"> MyError {</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    </span><span style="--0:#C792EA;--1:#8D46B4">fn</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3C63B3">fmt</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#7FDBCA;--1:#097174">&#x26;self</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#C5E478;--1:#3C63B3">f</span><span style="--0:#7FDBCA;--1:#097174">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#7FDBCA;--1:#097174">&#x26;</span><span style="--0:#C792EA;--1:#8D46B4">mut</span><span style="--0:#D6DEEB;--1:#403F53"> fmt</span><span style="--0:#7FDBCA;--1:#097174">::</span><span style="--0:#D6DEEB;--1:#403F53">Formatter) </span><span style="--0:#7FDBCA;--1:#097174">-></span><span style="--0:#D6DEEB;--1:#403F53"> fmt</span><span style="--0:#7FDBCA;--1:#097174">::</span><span style="--0:#D6DEEB;--1:#403F53">Result {</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">        </span><span style="--0:#C792EA;--1:#8D46B4">match</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#7FDBCA;--1:#097174">*self</span><span style="--0:#D6DEEB;--1:#403F53"> {</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">            MyError</span><span style="--0:#7FDBCA;--1:#097174">::</span><span style="--0:#82AAFF;--1:#3C63B3">IoError</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C792EA;--1:#8D46B4">ref</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3C63B3">e</span><span style="--0:#D6DEEB;--1:#403F53">) </span><span style="--0:#7FDBCA;--1:#097174">=></span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3C63B3">write!</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C5E478;--1:#3C63B3">f</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#9B504E">IO Error: {}</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#C5E478;--1:#3C63B3">e</span><span style="--0:#D6DEEB;--1:#403F53">),</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">            MyError</span><span style="--0:#7FDBCA;--1:#097174">::</span><span style="--0:#82AAFF;--1:#3C63B3">CustomError</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C792EA;--1:#8D46B4">ref</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3C63B3">msg</span><span style="--0:#D6DEEB;--1:#403F53">) </span><span style="--0:#7FDBCA;--1:#097174">=></span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3C63B3">write!</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C5E478;--1:#3C63B3">f</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#9B504E">Custom Error: {}</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#C5E478;--1:#3C63B3">msg</span><span style="--0:#D6DEEB;--1:#403F53">),</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">        }</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    }</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="use std::error::Error;use std::fmt;// 自定义错误类型#[derive(Debug)]enum MyError {    IoError(std::io::Error),    CustomError(String),}// 实现 Error traitimpl Error for MyError {}// 实现 Display trait 用于打印错误信息impl fmt::Display for MyError {    fn fmt(&#x26;self, f: &#x26;mut fmt::Formatter) -> fmt::Result {        match *self {            MyError::IoError(ref e) => write!(f, &#x22;IO Error: {}&#x22;, e),            MyError::CustomError(ref msg) => write!(f, &#x22;Custom Error: {}&#x22;, msg),        }    }}"><div></div></button></div></figure></div>
<h2 id="162-错误链">16.2 错误链</h2>
<p>Rust 允许你在错误处理中创建错误链，以跟踪错误的来源。这在调试复杂的错误时非常有用，因为它可以显示错误传播的路径。</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#809191;--1:#5E6578">// 定义一个函数 `foo`，它返回一个 Result 类型，其中包含一个错误对象</span></div><div class="ec-line"><span style="--0:#C792EA;--1:#8D46B4">fn</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3C63B3">foo</span><span style="--0:#D6DEEB;--1:#403F53">() </span><span style="--0:#7FDBCA;--1:#097174">-></span><span style="--0:#D6DEEB;--1:#403F53"> Result&#x3C;(), Box&#x3C;</span><span style="--0:#C792EA;--1:#8D46B4">dyn</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3C63B3">std</span><span style="--0:#7FDBCA;--1:#097174">::</span><span style="--0:#C5E478;--1:#3C63B3">error</span><span style="--0:#7FDBCA;--1:#097174">::</span><span style="--0:#D6DEEB;--1:#403F53">Error>> {</span></div><div class="ec-line"><span style="--0:#809191;--1:#5E6578">    // 模拟一个错误，创建一个包含自定义错误消息的 Result</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    </span><span style="--0:#C792EA;--1:#8D46B4">let</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3C63B3">err</span><span style="--0:#7FDBCA;--1:#097174">:</span><span style="--0:#D6DEEB;--1:#403F53"> Result&#x3C;(), Box&#x3C;</span><span style="--0:#C792EA;--1:#8D46B4">dyn</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3C63B3">std</span><span style="--0:#7FDBCA;--1:#097174">::</span><span style="--0:#C5E478;--1:#3C63B3">error</span><span style="--0:#7FDBCA;--1:#097174">::</span><span style="--0:#D6DEEB;--1:#403F53">Error>> </span><span style="--0:#C792EA;--1:#8D46B4">=</span><span style="--0:#D6DEEB;--1:#403F53"> Err(Box</span><span style="--0:#7FDBCA;--1:#097174">::</span><span style="--0:#82AAFF;--1:#3C63B3">new</span><span style="--0:#D6DEEB;--1:#403F53">(MyError</span><span style="--0:#7FDBCA;--1:#097174">::</span><span style="--0:#82AAFF;--1:#3C63B3">CustomError</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#9B504E">Something went wrong</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#7FDBCA;--1:#097174">.</span><span style="--0:#82AAFF;--1:#3C63B3">to_string</span><span style="--0:#D6DEEB;--1:#403F53">())));</span></div><div class="ec-line"><span style="--0:#809191;--1:#5E6578">    // 使用 `?` 运算符，如果 `err` 包含错误，则将错误立即返回</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    </span><span style="--0:#C5E478;--1:#3C63B3">err</span><span style="--0:#7FDBCA;--1:#097174">?</span><span style="--0:#D6DEEB;--1:#403F53">;</span></div><div class="ec-line"><span style="--0:#809191;--1:#5E6578">    // 如果没有错误，返回一个表示成功的 Ok(())</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    Ok(())</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">}</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#C792EA;--1:#8D46B4">fn</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3C63B3">main</span><span style="--0:#D6DEEB;--1:#403F53">() {</span></div><div class="ec-line"><span style="--0:#809191;--1:#5E6578">    // 调用 `foo` 函数并检查其返回值</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    </span><span style="--0:#C792EA;--1:#8D46B4">if</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8D46B4">let</span><span style="--0:#D6DEEB;--1:#403F53"> Err(</span><span style="--0:#C5E478;--1:#3C63B3">e</span><span style="--0:#D6DEEB;--1:#403F53">) </span><span style="--0:#C792EA;--1:#8D46B4">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3C63B3">foo</span><span style="--0:#D6DEEB;--1:#403F53">() {</span></div><div class="ec-line"><span style="--0:#809191;--1:#5E6578">        // 如果存在错误，打印错误消息</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">        </span><span style="--0:#82AAFF;--1:#3C63B3">println!</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#9B504E">Error: {}</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#C5E478;--1:#3C63B3">e</span><span style="--0:#D6DEEB;--1:#403F53">);</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#809191;--1:#5E6578">        // 初始化一个错误链的源（source）迭代器</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">        </span><span style="--0:#C792EA;--1:#8D46B4">let</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8D46B4">mut</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3C63B3">source</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8D46B4">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3C63B3">e</span><span style="--0:#7FDBCA;--1:#097174">.</span><span style="--0:#82AAFF;--1:#3C63B3">source</span><span style="--0:#D6DEEB;--1:#403F53">();</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#809191;--1:#5E6578">        // 使用迭代器遍历错误链</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">        </span><span style="--0:#C792EA;--1:#8D46B4">while</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8D46B4">let</span><span style="--0:#D6DEEB;--1:#403F53"> Some(</span><span style="--0:#C5E478;--1:#3C63B3">err</span><span style="--0:#D6DEEB;--1:#403F53">) </span><span style="--0:#C792EA;--1:#8D46B4">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3C63B3">source</span><span style="--0:#D6DEEB;--1:#403F53"> {</span></div><div class="ec-line"><span style="--0:#809191;--1:#5E6578">            // 打印每个错误链中的错误消息</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">            </span><span style="--0:#82AAFF;--1:#3C63B3">println!</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#9B504E">Caused by: {}</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#C5E478;--1:#3C63B3">err</span><span style="--0:#D6DEEB;--1:#403F53">);</span></div><div class="ec-line"><span style="--0:#809191;--1:#5E6578">            // 获取下一个错误链的源</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">            </span><span style="--0:#C5E478;--1:#3C63B3">source</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8D46B4">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3C63B3">err</span><span style="--0:#7FDBCA;--1:#097174">.</span><span style="--0:#82AAFF;--1:#3C63B3">source</span><span style="--0:#D6DEEB;--1:#403F53">();</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">        }</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    }</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="// 定义一个函数 &#x60;foo&#x60;，它返回一个 Result 类型，其中包含一个错误对象fn foo() -> Result<(), Box<dyn std::error::Error>> {    // 模拟一个错误，创建一个包含自定义错误消息的 Result    let err: Result<(), Box<dyn std::error::Error>> = Err(Box::new(MyError::CustomError(&#x22;Something went wrong&#x22;.to_string())));    // 使用 &#x60;?&#x60; 运算符，如果 &#x60;err&#x60; 包含错误，则将错误立即返回    err?;    // 如果没有错误，返回一个表示成功的 Ok(())    Ok(())}fn main() {    // 调用 &#x60;foo&#x60; 函数并检查其返回值    if let Err(e) = foo() {        // 如果存在错误，打印错误消息        println!(&#x22;Error: {}&#x22;, e);        // 初始化一个错误链的源（source）迭代器        let mut source = e.source();        // 使用迭代器遍历错误链        while let Some(err) = source {            // 打印每个错误链中的错误消息            println!(&#x22;Caused by: {}&#x22;, err);            // 获取下一个错误链的源            source = err.source();        }    }}"><div></div></button></div></figure></div>
<p><strong>执行结果：</strong></p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#d6deeb;--1:#403f53">Error: Something went wrong</span></div><div class="ec-line"><span style="--0:#d6deeb;--1:#403f53">Caused by: Something went wrong</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="Error: Something went wrongCaused by: Something went wrong"><div></div></button></div></figure></div>
<p>解释和原理：</p>
<ol>
<li><code dir="auto">fn foo() -> Result&#x3C;(), Box&#x3C;dyn std::error::Error>></code>：这是一个函数签名，表示 <code dir="auto">foo</code> 函数返回一个 <code dir="auto">Result</code> 类型，其中包含一个空元组 <code dir="auto">()</code>，表示成功时不返回具体的值。同时，错误类型为 <code dir="auto">Box&#x3C;dyn std::error::Error></code>，这意味着可以返回任何实现了 <code dir="auto">std::error::Error</code> trait 的错误类型。</li>
<li><code dir="auto">let err: Result&#x3C;(), Box&#x3C;dyn std::error::Error>> = Err(Box::new(MyError::CustomError("Something went wrong".to_string())));</code>：在函数内部，我们创建了一个自定义的错误对象 <code dir="auto">MyError::CustomError</code> 并将其包装在 <code dir="auto">Box</code> 中，然后将其包装成一个 <code dir="auto">Result</code> 对象 <code dir="auto">err</code>。这个错误表示 “Something went wrong”。</li>
<li><code dir="auto">err?;</code>：这是一个短路运算符，如果 <code dir="auto">err</code> 包含错误，则会立即返回错误，否则继续执行。在这种情况下，如果 <code dir="auto">err</code> 包含错误，<code dir="auto">foo</code> 函数会立即返回该错误。</li>
<li><code dir="auto">if let Err(e) = foo() { ... }</code>：在 <code dir="auto">main</code> 函数中，我们调用 <code dir="auto">foo</code> 函数并检查其返回值。如果返回的结果是错误，将错误对象绑定到变量 <code dir="auto">e</code> 中。</li>
<li><code dir="auto">println!("Error: {}", e);</code>：如果存在错误，打印错误消息。</li>
<li><code dir="auto">let mut source = e.source();</code>：初始化一个错误链的源（source）迭代器，以便遍历错误链。</li>
<li><code dir="auto">while let Some(err) = source { ... }</code>：使用 <code dir="auto">while let</code> 循环遍历错误链，逐个打印错误链中的错误消息，并获取下一个错误链的源。这允许你查看导致错误的全部历史。</li>
</ol>
<p>这段代码演示了如何处理错误，并在错误链中追踪错误的来源。这对于调试和排查问题非常有用，尤其是在复杂的错误场景下。</p>
<p>在量化金融 Rust 开发中，错误链可以应用于方方面面，以提高代码的可维护性和可靠性。以下是一些可能的应用场景：</p>
<ol>
<li>
<p><strong>数据源连接和解析：</strong> 在量化金融中，数据源可能来自各种市场数据提供商和交易所。使用错误链可以更好地处理数据源的连接错误、数据解析错误以及数据质量问题。</p>
</li>
<li>
<p><strong>策略执行和交易：</strong> 量化策略的执行和交易可能涉及到复杂的算法和订单管理。错误链可以用于跟踪策略执行中的错误，包括订单执行错误、价格计算错误等。</p>
</li>
<li>
<p><strong>数据存储和查询：</strong> 金融数据的存储和查询通常涉及数据库操作。错误链可用于处理数据库连接问题、数据插入/查询错误以及数据一致性问题。</p>
</li>
<li>
<p><strong>风险管理：</strong> 量化金融系统需要进行风险管理和监控。错误链可用于记录风险检测、风险限制违规以及风险报告生成中的问题。</p>
</li>
<li>
<p><strong>模型开发和验证：</strong> 金融模型的开发和验证可能涉及数学计算和模拟。错误链可以用于跟踪模型验证过程中的错误和异常情况。</p>
</li>
<li>
<p><strong>通信和报告：</strong> 金融系统需要与交易所、监管机构和客户进行通信。错误链可用于处理通信错误、报告生成错误以及与外部实体的交互中的问题。</p>
</li>
<li>
<p><strong>监控和告警：</strong> 错误链可用于建立监控系统，以检测系统性能问题、错误率上升和异常行为，并生成告警以及执行相应的应急措施。</p>
</li>
<li>
<p><strong>回测和性能优化：</strong> 在策略开发过程中，需要进行回测和性能优化。错误链可用于记录回测错误、性能测试结果和优化过程中的问题。</p>
</li>
<li>
<p><strong>数据隐私和安全性：</strong> 金融数据具有高度的敏感性，需要保护数据隐私和确保系统的安全性。错误链可用于处理安全性检查、身份验证错误以及数据泄露问题。</p>
</li>
<li>
<p><strong>版本控制和部署：</strong> 在金融系统的开发和部署过程中，可能会出现版本控制和部署错误。错误链可用于跟踪版本冲突、依赖问题以及部署失败。</p>
</li>
</ol>
<p>错误链的应用有助于更好地识别、记录和处理系统中的问题，提高系统的可维护性和稳定性，同时也有助于快速定位和解决潜在的问题。这对于量化金融系统非常重要，因为这些系统通常需要高度的可靠性和稳定性。</p>
<h3 id="补充学习-foo-和-bar">补充学习： foo 和 bar</h3>
<p>为什么计算机科学中喜欢使用 <code dir="auto">foo</code> 和 <code dir="auto">bar</code> 这样的名称是有多种说法历史渊源的。这些名称最早起源于早期计算机编程和计算机文化，根据wiki, foo 和 bar可能具有以下一些历史和传统背景：</p>
<ol>
<li><strong>Playful Allusion（俏皮暗示）：</strong> 有人认为 <code dir="auto">foobar</code> 可能是对二战时期军事俚语 “FUBAR”（Fucked Up Beyond All Recognition）的一种戏谑引用。这种引用可能是为了强调代码中的混乱或问题。</li>
<li><strong>Tech Model Railroad Club（TMRC）：</strong> 在编程上下文中，“foo” 和 “bar” 的首次印刷使用出现在麻省理工学院（MIT）的 Tech Engineering News 的 1965 年版中。“foo” 在编程上下文中的使用通常归功于 MIT 的 Tech Model Railroad Club（TMRC），大约在 1960 年左右。在 TMRC 的复杂模型系统中，房间各处都有紧急关闭开关，如果发生不期望的情况（例如，火车全速向障碍物前进），则可以触发这些开关。系统的另一个特点是调度板上的数字时钟。当有人按下关闭开关时，时钟停止运行，并且显示更改为单词 “FOO”；因此，在 TMRC，这些关闭开关被称为 “Foo 开关”。</li>
</ol>
<p>总的来说，“foo” 和 “bar” 这些命名习惯在计算机编程中的使用起源于早期计算机文化和编程社区，并且已经成为了一种传统。它们通常被用于示例代码、测试和文档中，以便简化示例的编写，并且不会对特定含义产生混淆。虽然它们是通用的、不具备特定含义的名称，但它们在编程社区中得到了广泛接受，并且用于教育和概念验证。</p>
<h3 id="补充学习-source方法">补充学习： source方法</h3>
<p>在 Rust 中，<code dir="auto">source</code> 方法是用于访问错误链中下一个错误源（source）的方法。它是由 <code dir="auto">std::error::Error</code> trait 提供的方法，允许你在错误处理中遍历错误链，以查看导致错误的全部历史。</p>
<p>以下是 <code dir="auto">source</code> 方法的签名：</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#C792EA;--1:#8D46B4">fn</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3C63B3">source</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#7FDBCA;--1:#097174">&#x26;self</span><span style="--0:#D6DEEB;--1:#403F53">) </span><span style="--0:#7FDBCA;--1:#097174">-></span><span style="--0:#D6DEEB;--1:#403F53"> Option&#x3C;</span><span style="--0:#7FDBCA;--1:#097174">&#x26;</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C792EA;--1:#8D46B4">dyn</span><span style="--0:#D6DEEB;--1:#403F53"> Error </span><span style="--0:#7FDBCA;--1:#097174">+</span><span style="--0:#D6DEEB;--1:#403F53"> 'static)></span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="fn source(&#x26;self) -> Option<&#x26;(dyn Error + &#x27;static)>"><div></div></button></div></figure></div>
<p>解释每个部分的含义：</p>
<ul>
<li>
<p><code dir="auto">fn source(&#x26;self)</code>：这是一个方法签名，表示一个方法名为 <code dir="auto">source</code>，接受 <code dir="auto">&#x26;self</code> 参数，也就是对实现了 <code dir="auto">std::error::Error</code> trait 的错误对象的引用。</p>
</li>
<li>
<p><code dir="auto">-> Option&#x3C;&#x26;(dyn Error + 'static)></code>：这是返回值类型，表示该方法返回一个 <code dir="auto">Option</code>，其中包含一个对下一个错误源（如果存在）的引用。<code dir="auto">Option</code> 可能是 <code dir="auto">Some</code>（包含错误源）或 <code dir="auto">None</code>（表示没有更多的错误源）。<code dir="auto">&#x26;(dyn Error + 'static)</code> 表示错误源的引用，<code dir="auto">dyn Error</code> 表示实现了 <code dir="auto">std::error::Error</code> trait 的错误类型。<code dir="auto">'static</code> 是错误源的生命周期，通常为静态生命周期，表示错误源的生命周期是静态的。</p>
</li>
</ul>
<p>要使用 <code dir="auto">source</code> 方法，你需要在实现了 <code dir="auto">std::error::Error</code> trait 的自定义错误类型上调用该方法，以访问下一个错误源（如果存在）。</p>
<h2 id="163-错误处理宏">16.3 错误处理宏</h2>
<p>Rust 的标准库和其他库提供了一些有用的宏，用于简化自定义错误处理的代码，例如，<code dir="auto">anyhow</code>、<code dir="auto">thiserror</code> 和 <code dir="auto">failure</code> 等库。</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#C792EA;--1:#8D46B4">use</span><span style="--0:#D6DEEB;--1:#403F53"> anyhow</span><span style="--0:#7FDBCA;--1:#097174">::</span><span style="--0:#D6DEEB;--1:#403F53">{Result, anyhow};</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#C792EA;--1:#8D46B4">fn</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3C63B3">foo</span><span style="--0:#D6DEEB;--1:#403F53">() </span><span style="--0:#7FDBCA;--1:#097174">-></span><span style="--0:#D6DEEB;--1:#403F53"> Result&#x3C;()> {</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    </span><span style="--0:#C792EA;--1:#8D46B4">let</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3C63B3">condition</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8D46B4">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3C63B3">false</span><span style="--0:#D6DEEB;--1:#403F53">;</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    </span><span style="--0:#C792EA;--1:#8D46B4">if</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3C63B3">condition</span><span style="--0:#D6DEEB;--1:#403F53"> {</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">        Ok(())</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    } </span><span style="--0:#C792EA;--1:#8D46B4">else</span><span style="--0:#D6DEEB;--1:#403F53"> {</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">        Err(</span><span style="--0:#82AAFF;--1:#3C63B3">anyhow!</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#9B504E">Something went wrong</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">))</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    }</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="use anyhow::{Result, anyhow};fn foo() -> Result<()> {    let condition = false;    if condition {        Ok(())    } else {        Err(anyhow!(&#x22;Something went wrong&#x22;))    }}"><div></div></button></div></figure></div>
<p>在上述示例中，我们使用 <code dir="auto">anyhow</code> 宏来创建一个带有错误消息的 <code dir="auto">Result</code>。</p>
<h2 id="164-把错误装箱">16.4 把错误“装箱”</h2>
<p>在 Rust 中处理多种错误类型，可以将它们装箱为 <code dir="auto">Box&#x3C;dyn error::Error></code> 类型的结果。这种做法有几个好处和原因：</p>
<ol>
<li><strong>统一的错误处理</strong>：使用 <code dir="auto">Box&#x3C;dyn error::Error></code> 类型可以统一处理不同类型的错误，无论错误类型是何种具体的类型，都可以用相同的方式处理。这简化了错误处理的代码，减少了冗余。</li>
<li><strong>错误信息的抽象</strong>：Rust 的错误处理机制允许捕获和处理不同类型的错误，但在上层代码中，通常只需关心错误的抽象信息，而不需要关心具体的错误类型。使用 <code dir="auto">Box&#x3C;dyn error::Error></code> 可以提供错误的抽象表示，而不暴露具体的错误类型给上层代码。</li>
<li><strong>错误的封装</strong>：将不同类型的错误装箱为 <code dir="auto">Box&#x3C;dyn error::Error></code> 可以将错误信息和原因进行封装。这允许在错误链中构建更丰富的信息，以便于调试和错误追踪。在实际应用中，一个错误可能会导致另一个错误，而 <code dir="auto">Box&#x3C;dyn error::Error></code> 允许将这些错误链接在一起。</li>
<li><strong>灵活性</strong>：使用 <code dir="auto">Box&#x3C;dyn error::Error></code> 作为错误类型，允许在运行时动态地处理不同类型的错误。这在某些情况下非常有用，例如处理来自不同来源的错误或插件系统中的错误。</li>
</ol>
<p>将错误装箱为 <code dir="auto">Box&#x3C;dyn error::Error></code> 是一种通用的、灵活的错误处理方式，它允许处理多种不同类型的错误，并提供了更好的错误信息管理和抽象。这种做法使得代码更容易编写、维护和扩展，同时也提供了更好的错误诊断和追踪功能。</p>
<h2 id="165-用-map方法-处理-option链条-case-required">16.5 用 map方法 处理 option链条 (case required)</h2>
<p>以下是一个趣味性的示例，模拟了制作寿司的过程，包括淘米、准备食材、烹饪和包裹。在这个示例中，我们使用 <code dir="auto">Option</code> 类型来表示每个制作步骤，并使用 <code dir="auto">map</code> 方法来模拟每个步骤的处理过程：</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">#![allow(dead_code)]</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#809191;--1:#5E6578">// 寿司的食材</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">#[derive(Debug)] </span><span style="--0:#C792EA;--1:#8D46B4">enum</span><span style="--0:#D6DEEB;--1:#403F53"> SushiIngredient { Rice, Fish, Seaweed, SoySauce, Wasabi }</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#809191;--1:#5E6578">// 寿司制作步骤</span></div><div class="ec-line"><span style="--0:#C792EA;--1:#8D46B4">struct</span><span style="--0:#D6DEEB;--1:#403F53"> WashedRice(SushiIngredient);</span></div><div class="ec-line"><span style="--0:#C792EA;--1:#8D46B4">struct</span><span style="--0:#D6DEEB;--1:#403F53"> PreparedIngredients(SushiIngredient);</span></div><div class="ec-line"><span style="--0:#C792EA;--1:#8D46B4">struct</span><span style="--0:#D6DEEB;--1:#403F53"> CookedSushi(SushiIngredient);</span></div><div class="ec-line"><span style="--0:#C792EA;--1:#8D46B4">struct</span><span style="--0:#D6DEEB;--1:#403F53"> WrappedSushi(SushiIngredient);</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#809191;--1:#5E6578">// 淘米。如果没有食材，就返回 `None`。否则返回淘好的米。</span></div><div class="ec-line"><span style="--0:#C792EA;--1:#8D46B4">fn</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3C63B3">wash_rice</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C5E478;--1:#3C63B3">ingredient</span><span style="--0:#7FDBCA;--1:#097174">:</span><span style="--0:#D6DEEB;--1:#403F53"> Option&#x3C;SushiIngredient>) </span><span style="--0:#7FDBCA;--1:#097174">-></span><span style="--0:#D6DEEB;--1:#403F53"> Option&#x3C;WashedRice> {</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    </span><span style="--0:#C5E478;--1:#3C63B3">ingredient</span><span style="--0:#7FDBCA;--1:#097174">.</span><span style="--0:#82AAFF;--1:#3C63B3">map</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C792EA;--1:#8D46B4">|</span><span style="--0:#C5E478;--1:#3C63B3">i</span><span style="--0:#C792EA;--1:#8D46B4">|</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3C63B3">WashedRice</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C5E478;--1:#3C63B3">i</span><span style="--0:#D6DEEB;--1:#403F53">))</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">}</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#809191;--1:#5E6578">// 准备食材。如果没有食材，就返回 `None`。否则返回准备好的食材。</span></div><div class="ec-line"><span style="--0:#C792EA;--1:#8D46B4">fn</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3C63B3">prepare_ingredients</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C5E478;--1:#3C63B3">rice</span><span style="--0:#7FDBCA;--1:#097174">:</span><span style="--0:#D6DEEB;--1:#403F53"> Option&#x3C;WashedRice>) </span><span style="--0:#7FDBCA;--1:#097174">-></span><span style="--0:#D6DEEB;--1:#403F53"> Option&#x3C;PreparedIngredients> {</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    </span><span style="--0:#C5E478;--1:#3C63B3">rice</span><span style="--0:#7FDBCA;--1:#097174">.</span><span style="--0:#82AAFF;--1:#3C63B3">map</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C792EA;--1:#8D46B4">|</span><span style="--0:#82AAFF;--1:#3C63B3">WashedRice</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C5E478;--1:#3C63B3">i</span><span style="--0:#D6DEEB;--1:#403F53">)</span><span style="--0:#C792EA;--1:#8D46B4">|</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3C63B3">PreparedIngredients</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C5E478;--1:#3C63B3">i</span><span style="--0:#D6DEEB;--1:#403F53">))</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">}</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#809191;--1:#5E6578">// 烹饪寿司。这里，我们使用 `map()` 来替代 `match` 以处理各种情况。</span></div><div class="ec-line"><span style="--0:#C792EA;--1:#8D46B4">fn</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3C63B3">cook_sushi</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C5E478;--1:#3C63B3">ingredients</span><span style="--0:#7FDBCA;--1:#097174">:</span><span style="--0:#D6DEEB;--1:#403F53"> Option&#x3C;PreparedIngredients>) </span><span style="--0:#7FDBCA;--1:#097174">-></span><span style="--0:#D6DEEB;--1:#403F53"> Option&#x3C;CookedSushi> {</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    </span><span style="--0:#C5E478;--1:#3C63B3">ingredients</span><span style="--0:#7FDBCA;--1:#097174">.</span><span style="--0:#82AAFF;--1:#3C63B3">map</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C792EA;--1:#8D46B4">|</span><span style="--0:#82AAFF;--1:#3C63B3">PreparedIngredients</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C5E478;--1:#3C63B3">i</span><span style="--0:#D6DEEB;--1:#403F53">)</span><span style="--0:#C792EA;--1:#8D46B4">|</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3C63B3">CookedSushi</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C5E478;--1:#3C63B3">i</span><span style="--0:#D6DEEB;--1:#403F53">))</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">}</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#809191;--1:#5E6578">// 包裹寿司。如果没有食材，就返回 `None`。否则返回包裹好的寿司。</span></div><div class="ec-line"><span style="--0:#C792EA;--1:#8D46B4">fn</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3C63B3">wrap_sushi</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C5E478;--1:#3C63B3">sushi</span><span style="--0:#7FDBCA;--1:#097174">:</span><span style="--0:#D6DEEB;--1:#403F53"> Option&#x3C;CookedSushi>) </span><span style="--0:#7FDBCA;--1:#097174">-></span><span style="--0:#D6DEEB;--1:#403F53"> Option&#x3C;WrappedSushi> {</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    </span><span style="--0:#C5E478;--1:#3C63B3">sushi</span><span style="--0:#7FDBCA;--1:#097174">.</span><span style="--0:#82AAFF;--1:#3C63B3">map</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C792EA;--1:#8D46B4">|</span><span style="--0:#82AAFF;--1:#3C63B3">CookedSushi</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C5E478;--1:#3C63B3">i</span><span style="--0:#D6DEEB;--1:#403F53">)</span><span style="--0:#C792EA;--1:#8D46B4">|</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3C63B3">WrappedSushi</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C5E478;--1:#3C63B3">i</span><span style="--0:#D6DEEB;--1:#403F53">))</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">}</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#809191;--1:#5E6578">// 吃寿司</span></div><div class="ec-line"><span style="--0:#C792EA;--1:#8D46B4">fn</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3C63B3">eat_sushi</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C5E478;--1:#3C63B3">sushi</span><span style="--0:#7FDBCA;--1:#097174">:</span><span style="--0:#D6DEEB;--1:#403F53"> Option&#x3C;WrappedSushi>) {</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    </span><span style="--0:#C792EA;--1:#8D46B4">match</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3C63B3">sushi</span><span style="--0:#D6DEEB;--1:#403F53"> {</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">        Some(</span><span style="--0:#82AAFF;--1:#3C63B3">WrappedSushi</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C5E478;--1:#3C63B3">i</span><span style="--0:#D6DEEB;--1:#403F53">)) </span><span style="--0:#7FDBCA;--1:#097174">=></span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3C63B3">println!</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#9B504E">Delicious sushi with {:?}</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#C5E478;--1:#3C63B3">i</span><span style="--0:#D6DEEB;--1:#403F53">),</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">        None                  </span><span style="--0:#7FDBCA;--1:#097174">=></span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3C63B3">println!</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#9B504E">Oops! Something went wrong.</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">),</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    }</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">}</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#C792EA;--1:#8D46B4">fn</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3C63B3">main</span><span style="--0:#D6DEEB;--1:#403F53">() {</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    </span><span style="--0:#C792EA;--1:#8D46B4">let</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3C63B3">rice</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8D46B4">=</span><span style="--0:#D6DEEB;--1:#403F53"> Some(SushiIngredient</span><span style="--0:#7FDBCA;--1:#097174">::</span><span style="--0:#D6DEEB;--1:#403F53">Rice);</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    </span><span style="--0:#C792EA;--1:#8D46B4">let</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3C63B3">fish</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8D46B4">=</span><span style="--0:#D6DEEB;--1:#403F53"> Some(SushiIngredient</span><span style="--0:#7FDBCA;--1:#097174">::</span><span style="--0:#D6DEEB;--1:#403F53">Fish);</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    </span><span style="--0:#C792EA;--1:#8D46B4">let</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3C63B3">seaweed</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8D46B4">=</span><span style="--0:#D6DEEB;--1:#403F53"> Some(SushiIngredient</span><span style="--0:#7FDBCA;--1:#097174">::</span><span style="--0:#D6DEEB;--1:#403F53">Seaweed);</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    </span><span style="--0:#C792EA;--1:#8D46B4">let</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3C63B3">soy_sauce</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8D46B4">=</span><span style="--0:#D6DEEB;--1:#403F53"> Some(SushiIngredient</span><span style="--0:#7FDBCA;--1:#097174">::</span><span style="--0:#D6DEEB;--1:#403F53">SoySauce);</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    </span><span style="--0:#C792EA;--1:#8D46B4">let</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3C63B3">wasabi</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8D46B4">=</span><span style="--0:#D6DEEB;--1:#403F53"> Some(SushiIngredient</span><span style="--0:#7FDBCA;--1:#097174">::</span><span style="--0:#D6DEEB;--1:#403F53">Wasabi);</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#809191;--1:#5E6578">    // 制作寿司</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    </span><span style="--0:#C792EA;--1:#8D46B4">let</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3C63B3">washed_rice</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8D46B4">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3C63B3">wash_rice</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C5E478;--1:#3C63B3">rice</span><span style="--0:#D6DEEB;--1:#403F53">);</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    </span><span style="--0:#C792EA;--1:#8D46B4">let</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3C63B3">prepared_ingredients</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8D46B4">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3C63B3">prepare_ingredients</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C5E478;--1:#3C63B3">washed_rice</span><span style="--0:#D6DEEB;--1:#403F53">);</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    </span><span style="--0:#C792EA;--1:#8D46B4">let</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3C63B3">cooked_sushi</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8D46B4">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3C63B3">cook_sushi</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C5E478;--1:#3C63B3">prepared_ingredients</span><span style="--0:#D6DEEB;--1:#403F53">);</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    </span><span style="--0:#C792EA;--1:#8D46B4">let</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3C63B3">wrapped_sushi</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8D46B4">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3C63B3">wrap_sushi</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C5E478;--1:#3C63B3">cooked_sushi</span><span style="--0:#D6DEEB;--1:#403F53">);</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#809191;--1:#5E6578">    // 吃寿司</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    </span><span style="--0:#82AAFF;--1:#3C63B3">eat_sushi</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C5E478;--1:#3C63B3">wrapped_sushi</span><span style="--0:#D6DEEB;--1:#403F53">);</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="#![allow(dead_code)]// 寿司的食材#[derive(Debug)] enum SushiIngredient { Rice, Fish, Seaweed, SoySauce, Wasabi }// 寿司制作步骤struct WashedRice(SushiIngredient);struct PreparedIngredients(SushiIngredient);struct CookedSushi(SushiIngredient);struct WrappedSushi(SushiIngredient);// 淘米。如果没有食材，就返回 &#x60;None&#x60;。否则返回淘好的米。fn wash_rice(ingredient: Option<SushiIngredient>) -> Option<WashedRice> {    ingredient.map(|i| WashedRice(i))}// 准备食材。如果没有食材，就返回 &#x60;None&#x60;。否则返回准备好的食材。fn prepare_ingredients(rice: Option<WashedRice>) -> Option<PreparedIngredients> {    rice.map(|WashedRice(i)| PreparedIngredients(i))}// 烹饪寿司。这里，我们使用 &#x60;map()&#x60; 来替代 &#x60;match&#x60; 以处理各种情况。fn cook_sushi(ingredients: Option<PreparedIngredients>) -> Option<CookedSushi> {    ingredients.map(|PreparedIngredients(i)| CookedSushi(i))}// 包裹寿司。如果没有食材，就返回 &#x60;None&#x60;。否则返回包裹好的寿司。fn wrap_sushi(sushi: Option<CookedSushi>) -> Option<WrappedSushi> {    sushi.map(|CookedSushi(i)| WrappedSushi(i))}// 吃寿司fn eat_sushi(sushi: Option<WrappedSushi>) {    match sushi {        Some(WrappedSushi(i)) => println!(&#x22;Delicious sushi with {:?}&#x22;, i),        None                  => println!(&#x22;Oops! Something went wrong.&#x22;),    }}fn main() {    let rice = Some(SushiIngredient::Rice);    let fish = Some(SushiIngredient::Fish);    let seaweed = Some(SushiIngredient::Seaweed);    let soy_sauce = Some(SushiIngredient::SoySauce);    let wasabi = Some(SushiIngredient::Wasabi);    // 制作寿司    let washed_rice = wash_rice(rice);    let prepared_ingredients = prepare_ingredients(washed_rice);    let cooked_sushi = cook_sushi(prepared_ingredients);    let wrapped_sushi = wrap_sushi(cooked_sushi);    // 吃寿司    eat_sushi(wrapped_sushi);}"><div></div></button></div></figure></div>
<p>这个示例模拟了制作寿司的流程，每个步骤都使用 <code dir="auto">Option</code> 表示，并使用 <code dir="auto">map</code> 方法进行处理。当食材经过一系列步骤后，最终制作出美味的寿司。</p>
<h2 id="166-and_then-方法">16.6 and_then 方法</h2>
<p>组合算子 <code dir="auto">and_then</code> 是另一种在 Rust 编程语言中常见的组合子（combinator）。它通常用于处理 Option 类型或 Result 类型的值，通过链式调用来组合多个操作。</p>
<p>在 Rust 中，<code dir="auto">and_then</code> 是一个方法，可以用于 Option 类型的值。它的作用是当 Option 值为 Some 时，执行指定的操作，并返回一个新的 Option 值。如果 Option 值为 None，则不执行任何操作，直接返回 None。</p>
<p>下面是一个使用 <code dir="auto">and_then</code> 的示例：</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#C792EA;--1:#8D46B4">let</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3C63B3">option1</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8D46B4">=</span><span style="--0:#D6DEEB;--1:#403F53"> Some(</span><span style="--0:#F78C6C;--1:#AA0982">10</span><span style="--0:#D6DEEB;--1:#403F53">);</span></div><div class="ec-line"><span style="--0:#C792EA;--1:#8D46B4">let</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3C63B3">option2</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8D46B4">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3C63B3">option1</span><span style="--0:#7FDBCA;--1:#097174">.</span><span style="--0:#82AAFF;--1:#3C63B3">and_then</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C792EA;--1:#8D46B4">|</span><span style="--0:#C5E478;--1:#3C63B3">x</span><span style="--0:#C792EA;--1:#8D46B4">|</span><span style="--0:#D6DEEB;--1:#403F53"> Some(</span><span style="--0:#C5E478;--1:#3C63B3">x</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#7FDBCA;--1:#097174">+</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#F78C6C;--1:#AA0982">5</span><span style="--0:#D6DEEB;--1:#403F53">));</span></div><div class="ec-line"><span style="--0:#C792EA;--1:#8D46B4">let</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3C63B3">option3</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8D46B4">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3C63B3">option2</span><span style="--0:#7FDBCA;--1:#097174">.</span><span style="--0:#82AAFF;--1:#3C63B3">and_then</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C792EA;--1:#8D46B4">|</span><span style="--0:#C5E478;--1:#3C63B3">x</span><span style="--0:#C792EA;--1:#8D46B4">|</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8D46B4">if</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3C63B3">x</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8D46B4">></span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#F78C6C;--1:#AA0982">15</span><span style="--0:#D6DEEB;--1:#403F53"> { Some(</span><span style="--0:#C5E478;--1:#3C63B3">x</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#7FDBCA;--1:#097174">*</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#F78C6C;--1:#AA0982">2</span><span style="--0:#D6DEEB;--1:#403F53">) } </span><span style="--0:#C792EA;--1:#8D46B4">else</span><span style="--0:#D6DEEB;--1:#403F53"> { None });</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#C792EA;--1:#8D46B4">match</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3C63B3">option3</span><span style="--0:#D6DEEB;--1:#403F53"> {</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    Some(</span><span style="--0:#C5E478;--1:#3C63B3">value</span><span style="--0:#D6DEEB;--1:#403F53">) </span><span style="--0:#7FDBCA;--1:#097174">=></span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3C63B3">println!</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#9B504E">Option 3: {}</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#C5E478;--1:#3C63B3">value</span><span style="--0:#D6DEEB;--1:#403F53">),</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    None </span><span style="--0:#7FDBCA;--1:#097174">=></span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3C63B3">println!</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#9B504E">Option 3 is None</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">),</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="let option1 = Some(10);let option2 = option1.and_then(|x| Some(x + 5));let option3 = option2.and_then(|x| if x > 15 { Some(x * 2) } else { None });match option3 {    Some(value) => println!(&#x22;Option 3: {}&#x22;, value),    None => println!(&#x22;Option 3 is None&#x22;),}"><div></div></button></div></figure></div>
<p>在上面的示例中，我们首先创建了一个 Option 值 <code dir="auto">option1</code>，其值为 Some(10)。然后，我们使用 <code dir="auto">and_then</code> 方法对 <code dir="auto">option1</code> 进行操作，将其值加上 5，并将结果包装为一个新的 Option 值 <code dir="auto">option2</code>。接着，我们再次使用 <code dir="auto">and_then</code> 方法对 <code dir="auto">option2</code> 进行操作，如果值大于 15，则将其乘以 2，否则返回 None。最后，我们将结果赋值给 <code dir="auto">option3</code>。</p>
<p>根据示例中的操作，<code dir="auto">option3</code> 的值将为 Some(30)，因为 10 + 5 = 15，15 > 15，所以乘以 2 得到 30。</p>
<p>通过链式调用 <code dir="auto">and_then</code> 方法，我们可以将多个操作组合在一起，以便在 Option 值上执行一系列的计算或转换。这种组合子的使用可以使代码更加简洁和易读。</p>
<h2 id="167-用filter_map-方法忽略空值">16.7 用filter_map 方法忽略空值</h2>
<p>在 Rust 中，可以使用 <code dir="auto">filter_map</code> 方法来忽略集合中的空值。这对于从集合中过滤掉 <code dir="auto">None</code> 值并同时提取 <code dir="auto">Some</code> 值非常有用。下面是一个示例：</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#C792EA;--1:#8D46B4">fn</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3C63B3">main</span><span style="--0:#D6DEEB;--1:#403F53">() {</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    </span><span style="--0:#C792EA;--1:#8D46B4">let</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3C63B3">values</span><span style="--0:#7FDBCA;--1:#097174">:</span><span style="--0:#D6DEEB;--1:#403F53"> Vec&#x3C;Option&#x3C;i32>> </span><span style="--0:#C792EA;--1:#8D46B4">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3C63B3">vec!</span><span style="--0:#D6DEEB;--1:#403F53">[Some(</span><span style="--0:#F78C6C;--1:#AA0982">1</span><span style="--0:#D6DEEB;--1:#403F53">), None, Some(</span><span style="--0:#F78C6C;--1:#AA0982">2</span><span style="--0:#D6DEEB;--1:#403F53">), None, Some(</span><span style="--0:#F78C6C;--1:#AA0982">3</span><span style="--0:#D6DEEB;--1:#403F53">)];</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#809191;--1:#5E6578">    // 使用 filter_map 过滤掉 None 值并提取 Some 值</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    </span><span style="--0:#C792EA;--1:#8D46B4">let</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3C63B3">filtered_values</span><span style="--0:#7FDBCA;--1:#097174">:</span><span style="--0:#D6DEEB;--1:#403F53"> Vec&#x3C;i32> </span><span style="--0:#C792EA;--1:#8D46B4">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3C63B3">values</span><span style="--0:#7FDBCA;--1:#097174">.</span><span style="--0:#82AAFF;--1:#3C63B3">into_iter</span><span style="--0:#D6DEEB;--1:#403F53">()</span><span style="--0:#7FDBCA;--1:#097174">.</span><span style="--0:#82AAFF;--1:#3C63B3">filter_map</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C792EA;--1:#8D46B4">|</span><span style="--0:#C5E478;--1:#3C63B3">x</span><span style="--0:#C792EA;--1:#8D46B4">|</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3C63B3">x</span><span style="--0:#D6DEEB;--1:#403F53">)</span><span style="--0:#7FDBCA;--1:#097174">.</span><span style="--0:#82AAFF;--1:#3C63B3">collect</span><span style="--0:#D6DEEB;--1:#403F53">();</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    </span><span style="--0:#82AAFF;--1:#3C63B3">println!</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#9B504E">{:?}</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#C5E478;--1:#3C63B3">filtered_values</span><span style="--0:#D6DEEB;--1:#403F53">);</span><span style="--0:#809191;--1:#5E6578"> // 输出 [1, 2, 3]</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="fn main() {    let values: Vec<Option<i32>> = vec![Some(1), None, Some(2), None, Some(3)];    // 使用 filter_map 过滤掉 None 值并提取 Some 值    let filtered_values: Vec<i32> = values.into_iter().filter_map(|x| x).collect();    println!(&#x22;{:?}&#x22;, filtered_values); // 输出 [1, 2, 3]}"><div></div></button></div></figure></div>
<p>在上面的示例中，我们有一个包含 <code dir="auto">Option&#x3C;i32></code> 值的 <code dir="auto">values</code> 向量。我们使用 <code dir="auto">filter_map</code> 方法来过滤掉 <code dir="auto">None</code> 值并提取 <code dir="auto">Some</code> 值，最终将结果收集到一个新的 <code dir="auto">Vec&#x3C;i32></code> 中。这样，我们就得到了一个只包含非空值的新集合 <code dir="auto">filtered_values</code>。</p>
<h3 id="案例-数据清洗">案例： 数据清洗</h3>
<p>在量化金融领域，Rust 中的 <code dir="auto">filter_map</code> 方法可以用于处理和清理数据。以下是一个示例，演示了如何在一个包含金融数据的 <code dir="auto">Vec&#x3C;Option&#x3C;f64>></code> 中过滤掉空值（<code dir="auto">None</code>）并提取有效的价格数据（<code dir="auto">Some</code> 值）：</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#C792EA;--1:#8D46B4">fn</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3C63B3">main</span><span style="--0:#D6DEEB;--1:#403F53">() {</span></div><div class="ec-line"><span style="--0:#809191;--1:#5E6578">    // 模拟一个包含金融价格数据的向量</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    </span><span style="--0:#C792EA;--1:#8D46B4">let</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3C63B3">financial_data</span><span style="--0:#7FDBCA;--1:#097174">:</span><span style="--0:#D6DEEB;--1:#403F53"> Vec&#x3C;Option&#x3C;f64>> </span><span style="--0:#C792EA;--1:#8D46B4">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3C63B3">vec!</span><span style="--0:#D6DEEB;--1:#403F53">[</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">        Some(</span><span style="--0:#F78C6C;--1:#AA0982">100.0</span><span style="--0:#D6DEEB;--1:#403F53">),</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">        Some(</span><span style="--0:#F78C6C;--1:#AA0982">105.5</span><span style="--0:#D6DEEB;--1:#403F53">),</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">        None,</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">        Some(</span><span style="--0:#F78C6C;--1:#AA0982">98.75</span><span style="--0:#D6DEEB;--1:#403F53">),</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">        None,</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">        Some(</span><span style="--0:#F78C6C;--1:#AA0982">102.3</span><span style="--0:#D6DEEB;--1:#403F53">),</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    ];</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#809191;--1:#5E6578">    // 使用 filter_map 过滤掉空值并提取价格数据</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    </span><span style="--0:#C792EA;--1:#8D46B4">let</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3C63B3">valid_prices</span><span style="--0:#7FDBCA;--1:#097174">:</span><span style="--0:#D6DEEB;--1:#403F53"> Vec&#x3C;f64> </span><span style="--0:#C792EA;--1:#8D46B4">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3C63B3">financial_data</span><span style="--0:#7FDBCA;--1:#097174">.</span><span style="--0:#82AAFF;--1:#3C63B3">into_iter</span><span style="--0:#D6DEEB;--1:#403F53">()</span><span style="--0:#7FDBCA;--1:#097174">.</span><span style="--0:#82AAFF;--1:#3C63B3">filter_map</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C792EA;--1:#8D46B4">|</span><span style="--0:#C5E478;--1:#3C63B3">price</span><span style="--0:#C792EA;--1:#8D46B4">|</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3C63B3">price</span><span style="--0:#D6DEEB;--1:#403F53">)</span><span style="--0:#7FDBCA;--1:#097174">.</span><span style="--0:#82AAFF;--1:#3C63B3">collect</span><span style="--0:#D6DEEB;--1:#403F53">();</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#809191;--1:#5E6578">    // 打印有效价格数据</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    </span><span style="--0:#C792EA;--1:#8D46B4">for</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3C63B3">price</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8D46B4">in</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#7FDBCA;--1:#097174">&#x26;</span><span style="--0:#C5E478;--1:#3C63B3">valid_prices</span><span style="--0:#D6DEEB;--1:#403F53"> {</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">        </span><span style="--0:#82AAFF;--1:#3C63B3">println!</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#9B504E">Price: {}</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#C5E478;--1:#3C63B3">price</span><span style="--0:#D6DEEB;--1:#403F53">);</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    }</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="fn main() {    // 模拟一个包含金融价格数据的向量    let financial_data: Vec<Option<f64>> = vec![        Some(100.0),        Some(105.5),        None,        Some(98.75),        None,        Some(102.3),    ];    // 使用 filter_map 过滤掉空值并提取价格数据    let valid_prices: Vec<f64> = financial_data.into_iter().filter_map(|price| price).collect();    // 打印有效价格数据    for price in &#x26;valid_prices {        println!(&#x22;Price: {}&#x22;, price);    }}"><div></div></button></div></figure></div>
<p>在这个示例中，我们模拟了一个包含金融价格数据的向量 <code dir="auto">financial_data</code>，其中有一些条目是空值（<code dir="auto">None</code>）。我们使用 <code dir="auto">filter_map</code> 方法将有效的价格数据提取到新的向量 <code dir="auto">valid_prices</code> 中。然后再打印。</p>
<h2 id="168-用collect-方法让整个操作链条失败">16.8 用collect 方法让整个操作链条失败</h2>
<p>在 Rust 中，可以使用 <code dir="auto">collect</code> 方法将一个 <code dir="auto">Iterator</code> 转换为一个 <code dir="auto">Result</code>，并且一旦遇到 <code dir="auto">Result::Err</code>，遍历就会终止。这在处理一系列 <code dir="auto">Result</code> 类型的操作时非常有用，因为只要有一个操作失败，整个操作可以立即失败并返回错误。</p>
<p>以下是一个示例，演示了如何使用 <code dir="auto">collect</code> 方法将一个包含 <code dir="auto">Result&#x3C;i32, Error></code> 的迭代器转换为 <code dir="auto">Result&#x3C;Vec&#x3C;i32>, Error></code>，并且如果其中任何一个 <code dir="auto">Result</code> 是错误的，整个操作就失败：</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">#[derive(Debug)]</span></div><div class="ec-line"><span style="--0:#C792EA;--1:#8D46B4">struct</span><span style="--0:#D6DEEB;--1:#403F53"> Error {</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    </span><span style="--0:#C5E478;--1:#3C63B3">message</span><span style="--0:#7FDBCA;--1:#097174">:</span><span style="--0:#D6DEEB;--1:#403F53"> String,</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">}</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#C792EA;--1:#8D46B4">fn</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3C63B3">main</span><span style="--0:#D6DEEB;--1:#403F53">() {</span></div><div class="ec-line"><span style="--0:#809191;--1:#5E6578">    // 模拟包含 Result 类型的迭代器</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    </span><span style="--0:#C792EA;--1:#8D46B4">let</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3C63B3">data</span><span style="--0:#7FDBCA;--1:#097174">:</span><span style="--0:#D6DEEB;--1:#403F53"> Vec&#x3C;Result&#x3C;i32, Error>> </span><span style="--0:#C792EA;--1:#8D46B4">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3C63B3">vec!</span><span style="--0:#D6DEEB;--1:#403F53">[Ok(</span><span style="--0:#F78C6C;--1:#AA0982">1</span><span style="--0:#D6DEEB;--1:#403F53">), Ok(</span><span style="--0:#F78C6C;--1:#AA0982">2</span><span style="--0:#D6DEEB;--1:#403F53">), Err(Error { </span><span style="--0:#C5E478;--1:#3C63B3">message</span><span style="--0:#7FDBCA;--1:#097174">:</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#9B504E">Error 1</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#7FDBCA;--1:#097174">.</span><span style="--0:#82AAFF;--1:#3C63B3">to_string</span><span style="--0:#D6DEEB;--1:#403F53">() }), Ok(</span><span style="--0:#F78C6C;--1:#AA0982">3</span><span style="--0:#D6DEEB;--1:#403F53">)];</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#809191;--1:#5E6578">    // 使用 collect 将 Result 迭代器转换为 Result&#x3C;Vec&#x3C;i32>, Error></span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    </span><span style="--0:#C792EA;--1:#8D46B4">let</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3C63B3">result</span><span style="--0:#7FDBCA;--1:#097174">:</span><span style="--0:#D6DEEB;--1:#403F53"> Result&#x3C;Vec&#x3C;i32>, Error> </span><span style="--0:#C792EA;--1:#8D46B4">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3C63B3">data</span><span style="--0:#7FDBCA;--1:#097174">.</span><span style="--0:#82AAFF;--1:#3C63B3">into_iter</span><span style="--0:#D6DEEB;--1:#403F53">()</span><span style="--0:#7FDBCA;--1:#097174">.</span><span style="--0:#82AAFF;--1:#3C63B3">collect</span><span style="--0:#D6DEEB;--1:#403F53">();</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#809191;--1:#5E6578">    // 处理结果</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    </span><span style="--0:#C792EA;--1:#8D46B4">match</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3C63B3">result</span><span style="--0:#D6DEEB;--1:#403F53"> {</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">        Ok(</span><span style="--0:#C5E478;--1:#3C63B3">numbers</span><span style="--0:#D6DEEB;--1:#403F53">) </span><span style="--0:#7FDBCA;--1:#097174">=></span><span style="--0:#D6DEEB;--1:#403F53"> {</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">            </span><span style="--0:#82AAFF;--1:#3C63B3">println!</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#9B504E">Valid numbers: {:?}</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#C5E478;--1:#3C63B3">numbers</span><span style="--0:#D6DEEB;--1:#403F53">);</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">        }</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">        Err(</span><span style="--0:#C5E478;--1:#3C63B3">err</span><span style="--0:#D6DEEB;--1:#403F53">) </span><span style="--0:#7FDBCA;--1:#097174">=></span><span style="--0:#D6DEEB;--1:#403F53"> {</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">            </span><span style="--0:#82AAFF;--1:#3C63B3">println!</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#9B504E">Error occurred: {:?}</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#C5E478;--1:#3C63B3">err</span><span style="--0:#D6DEEB;--1:#403F53">);</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">        }</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    }</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="#[derive(Debug)]struct Error {    message: String,}fn main() {    // 模拟包含 Result 类型的迭代器    let data: Vec<Result<i32, Error>> = vec![Ok(1), Ok(2), Err(Error { message: &#x22;Error 1&#x22;.to_string() }), Ok(3)];    // 使用 collect 将 Result 迭代器转换为 Result<Vec<i32>, Error>    let result: Result<Vec<i32>, Error> = data.into_iter().collect();    // 处理结果    match result {        Ok(numbers) => {            println!(&#x22;Valid numbers: {:?}&#x22;, numbers);        }        Err(err) => {            println!(&#x22;Error occurred: {:?}&#x22;, err);        }    }}"><div></div></button></div></figure></div>
<p>在这个示例中，<code dir="auto">data</code> 是一个包含 <code dir="auto">Result</code> 类型的迭代器，其中一个 <code dir="auto">Result</code> 是一个错误。通过使用 <code dir="auto">collect</code> 方法，我们试图将这些 <code dir="auto">Result</code> 收集到一个 <code dir="auto">Result&#x3C;Vec&#x3C;i32>, Error></code> 中。由于有一个错误的 <code dir="auto">Result</code>，整个操作失败，最终结果是一个 <code dir="auto">Result::Err</code>，并且我们可以捕获和处理错误。</p>
<h3 id="思考collect方法在金融领域有哪些用">思考：collect方法在金融领域有哪些用？</h3>
<p>在量化金融领域，这种使用 <code dir="auto">Result</code> 和 <code dir="auto">collect</code> 的方法可以应用于一系列数据分析、策略执行或交易操作。以下是一些可能的应用场景：</p>
<ol>
<li>
<p><strong>数据清洗和预处理</strong>：在量化金融中，需要处理大量的金融数据，包括市场价格、财务报告等。这些数据可能包含错误或缺失值。使用 <code dir="auto">Result</code> 和 <code dir="auto">collect</code> 可以逐行处理数据，将每个数据点的处理结果（可能是成功的 <code dir="auto">Result</code> 或失败的 <code dir="auto">Result</code>）收集到一个结果向量中。如果有任何错误发生，整个数据预处理操作可以被标记为失败，确保不会使用不可靠的数据进行后续分析或交易。</p>
</li>
<li>
<p><strong>策略执行</strong>：在量化交易中，需要执行一系列交易策略。每个策略的执行可能会导致成功或失败的交易。使用 <code dir="auto">Result</code> 和 <code dir="auto">collect</code> 可以确保只有当所有策略都成功执行时，才会执行后续操作，例如订单提交。如果任何一个策略执行失败，整个策略组合可以被标记为失败，以避免不必要的风险。</p>
</li>
<li>
<p><strong>订单处理</strong>：在金融交易中，订单通常需要经历多个步骤，包括校验、拆分、路由、执行等。每个步骤都可能失败。使用 <code dir="auto">Result</code> 和 <code dir="auto">collect</code> 可以确保只有当所有订单的每个步骤都成功完成时，整个批量订单处理操作才会继续进行。这有助于避免不完整或错误的订单被提交到市场。</p>
</li>
<li>
<p><strong>风险管理</strong>：量化金融公司需要不断监控和管理其风险曝露。如果某个风险分析或监控操作失败，可能会导致对风险的不正确估计。使用 <code dir="auto">Result</code> 和 <code dir="auto">collect</code> 可以确保只有在所有风险操作都成功完成时，风险管理系统才会生成可靠的报告。</p>
</li>
</ol>
<p>总之，<code dir="auto">Result</code> 和 <code dir="auto">collect</code> 的组合在量化金融领域可以用于确保数据的可靠性、策略的正确执行以及风险的有效管理。这有助于维护金融系统的稳定性和可靠性，降低操作错误的风险。</p>
<h3 id="案例与门逻辑的策略链条">案例：“与门”逻辑的策略链条</h3>
<p>”与门”（AND gate）是数字逻辑电路中的一种基本门电路，用于实现逻辑运算。与门的运算规则如下：</p>
<ul>
<li>当所有输入都是逻辑 “1” 时，输出为逻辑 “1”。</li>
<li>只要有一个或多个输入为逻辑 “0”，输出为逻辑 “0”。</li>
</ul>
<p>以下是一个简单的示例，演示了如何使用 <code dir="auto">Result</code> 和 <code dir="auto">collect</code> 来执行“与门”逻辑的策略链条，并确保只有当所有策略成功执行时，才会提交订单。</p>
<p>假设我们有三个交易策略，每个策略都有一个函数，它返回一个 <code dir="auto">Result</code>，其中 <code dir="auto">Ok</code> 表示策略成功执行，<code dir="auto">Err</code> 表示策略执行失败。我们希望只有当所有策略都成功时才执行后续操作。</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#809191;--1:#5E6578">// 定义交易策略和其执行函数</span></div><div class="ec-line"><span style="--0:#C792EA;--1:#8D46B4">fn</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3C63B3">strategy_1</span><span style="--0:#D6DEEB;--1:#403F53">() </span><span style="--0:#7FDBCA;--1:#097174">-></span><span style="--0:#D6DEEB;--1:#403F53"> Result&#x3C;(), </span><span style="--0:#7FDBCA;--1:#097174">&#x26;</span><span style="--0:#D6DEEB;--1:#403F53">'static str> {</span></div><div class="ec-line"><span style="--0:#809191;--1:#5E6578">    // 模拟策略执行成功</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    Ok(())</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">}</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#C792EA;--1:#8D46B4">fn</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3C63B3">strategy_2</span><span style="--0:#D6DEEB;--1:#403F53">() </span><span style="--0:#7FDBCA;--1:#097174">-></span><span style="--0:#D6DEEB;--1:#403F53"> Result&#x3C;(), </span><span style="--0:#7FDBCA;--1:#097174">&#x26;</span><span style="--0:#D6DEEB;--1:#403F53">'static str> {</span></div><div class="ec-line"><span style="--0:#809191;--1:#5E6578">    // 模拟策略执行失败</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    Err(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#9B504E">Strategy 2 failed</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">)</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">}</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#C792EA;--1:#8D46B4">fn</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3C63B3">strategy_3</span><span style="--0:#D6DEEB;--1:#403F53">() </span><span style="--0:#7FDBCA;--1:#097174">-></span><span style="--0:#D6DEEB;--1:#403F53"> Result&#x3C;(), </span><span style="--0:#7FDBCA;--1:#097174">&#x26;</span><span style="--0:#D6DEEB;--1:#403F53">'static str> {</span></div><div class="ec-line"><span style="--0:#809191;--1:#5E6578">    // 模拟策略执行成功</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    Ok(())</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">}</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#C792EA;--1:#8D46B4">fn</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3C63B3">main</span><span style="--0:#D6DEEB;--1:#403F53">() {</span></div><div class="ec-line"><span style="--0:#809191;--1:#5E6578">    // 创建一个包含所有策略的向量</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    </span><span style="--0:#C792EA;--1:#8D46B4">let</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3C63B3">strategies</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C792EA;--1:#8D46B4">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3C63B3">vec!</span><span style="--0:#D6DEEB;--1:#403F53">[</span><span style="--0:#C5E478;--1:#3C63B3">strategy_1</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#C5E478;--1:#3C63B3">strategy_2</span><span style="--0:#D6DEEB;--1:#403F53">, </span><span style="--0:#C5E478;--1:#3C63B3">strategy_3</span><span style="--0:#D6DEEB;--1:#403F53">];</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#809191;--1:#5E6578">    // 使用 `collect` 将所有策略的结果收集到一个向量中</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    </span><span style="--0:#C792EA;--1:#8D46B4">let</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3C63B3">results</span><span style="--0:#7FDBCA;--1:#097174">:</span><span style="--0:#D6DEEB;--1:#403F53"> Vec&#x3C;Result&#x3C;(), </span><span style="--0:#7FDBCA;--1:#097174">&#x26;</span><span style="--0:#D6DEEB;--1:#403F53">'static str>> </span><span style="--0:#C792EA;--1:#8D46B4">=</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3C63B3">strategies</span><span style="--0:#7FDBCA;--1:#097174">.</span><span style="--0:#82AAFF;--1:#3C63B3">into_iter</span><span style="--0:#D6DEEB;--1:#403F53">()</span><span style="--0:#7FDBCA;--1:#097174">.</span><span style="--0:#82AAFF;--1:#3C63B3">map</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C792EA;--1:#8D46B4">|</span><span style="--0:#C5E478;--1:#3C63B3">f</span><span style="--0:#C792EA;--1:#8D46B4">|</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#82AAFF;--1:#3C63B3">f</span><span style="--0:#D6DEEB;--1:#403F53">())</span><span style="--0:#7FDBCA;--1:#097174">.</span><span style="--0:#82AAFF;--1:#3C63B3">collect</span><span style="--0:#D6DEEB;--1:#403F53">();</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#809191;--1:#5E6578">    // 检查是否存在失败的策略</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    </span><span style="--0:#C792EA;--1:#8D46B4">if</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3C63B3">results</span><span style="--0:#7FDBCA;--1:#097174">.</span><span style="--0:#82AAFF;--1:#3C63B3">iter</span><span style="--0:#D6DEEB;--1:#403F53">()</span><span style="--0:#7FDBCA;--1:#097174">.</span><span style="--0:#82AAFF;--1:#3C63B3">any</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#C792EA;--1:#8D46B4">|</span><span style="--0:#C5E478;--1:#3C63B3">result</span><span style="--0:#C792EA;--1:#8D46B4">|</span><span style="--0:#D6DEEB;--1:#403F53"> </span><span style="--0:#C5E478;--1:#3C63B3">result</span><span style="--0:#7FDBCA;--1:#097174">.</span><span style="--0:#82AAFF;--1:#3C63B3">is_err</span><span style="--0:#D6DEEB;--1:#403F53">()) {</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">        </span><span style="--0:#82AAFF;--1:#3C63B3">println!</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#9B504E">One or more strategies failed. Aborting!</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">);</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">        </span><span style="--0:#C792EA;--1:#8D46B4">return</span><span style="--0:#D6DEEB;--1:#403F53">;</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    }</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#809191;--1:#5E6578">    // 所有策略成功执行，提交订单或执行后续操作</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">    </span><span style="--0:#82AAFF;--1:#3C63B3">println!</span><span style="--0:#D6DEEB;--1:#403F53">(</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#ECC48D;--1:#9B504E">All strategies executed successfully. Submitting orders...</span><span style="--0:#D9F5DD;--1:#111111">"</span><span style="--0:#D6DEEB;--1:#403F53">);</span></div><div class="ec-line"><span style="--0:#D6DEEB;--1:#403F53">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="// 定义交易策略和其执行函数fn strategy_1() -> Result<(), &#x26;&#x27;static str> {    // 模拟策略执行成功    Ok(())}fn strategy_2() -> Result<(), &#x26;&#x27;static str> {    // 模拟策略执行失败    Err(&#x22;Strategy 2 failed&#x22;)}fn strategy_3() -> Result<(), &#x26;&#x27;static str> {    // 模拟策略执行成功    Ok(())}fn main() {    // 创建一个包含所有策略的向量    let strategies = vec![strategy_1, strategy_2, strategy_3];    // 使用 &#x60;collect&#x60; 将所有策略的结果收集到一个向量中    let results: Vec<Result<(), &#x26;&#x27;static str>> = strategies.into_iter().map(|f| f()).collect();    // 检查是否存在失败的策略    if results.iter().any(|result| result.is_err()) {        println!(&#x22;One or more strategies failed. Aborting!&#x22;);        return;    }    // 所有策略成功执行，提交订单或执行后续操作    println!(&#x22;All strategies executed successfully. Submitting orders...&#x22;);}"><div></div></button></div></figure></div>
<p>因为我们的其中一个策略失败了，所以返回的是：</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#d6deeb;--1:#403f53">One or more strategies failed. Aborting!</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="One or more strategies failed. Aborting!"><div></div></button></div></figure></div>
<p>在这个示例中，我们使用 <code dir="auto">collect</code> 将策略函数的结果收集到一个向量中。然后，我们使用 <code dir="auto">iter().any()</code> 来检查向量中是否存在失败的结果。如果存在失败的结果，我们可以中止一切后续操作以避免不必要的风险。</p> </div> <footer class="astro-w7wtsaw6"> <div class="meta sl-flex astro-w7wtsaw6">   </div> <div class="pagination-links astro-qnftudm7" dir="ltr"> <a href="/chapters/chapter_15/" rel="prev" class="astro-qnftudm7"> <svg aria-hidden="true" class="astro-qnftudm7 astro-xrndq6a6" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1.5rem;"><path d="M17 11H9.41l3.3-3.29a1.004 1.004 0 1 0-1.42-1.42l-5 5a1 1 0 0 0-.21.33 1 1 0 0 0 0 .76 1 1 0 0 0 .21.33l5 5a1.002 1.002 0 0 0 1.639-.325 1 1 0 0 0-.219-1.095L9.41 13H17a1 1 0 0 0 0-2Z"/></svg>  <span class="astro-qnftudm7"> Previous <br class="astro-qnftudm7"> <span class="link-title astro-qnftudm7">15. 作用域规则和生命周期</span> </span> </a> <a href="/chapters/chapter_17/" rel="next" class="astro-qnftudm7"> <svg aria-hidden="true" class="astro-qnftudm7 astro-xrndq6a6" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1.5rem;"><path d="M17.92 11.62a1.001 1.001 0 0 0-.21-.33l-5-5a1.003 1.003 0 1 0-1.42 1.42l3.3 3.29H7a1 1 0 0 0 0 2h7.59l-3.3 3.29a1.002 1.002 0 0 0 .325 1.639 1 1 0 0 0 1.095-.219l5-5a1 1 0 0 0 .21-.33 1 1 0 0 0 0-.76Z"/></svg>  <span class="astro-qnftudm7"> Next <br class="astro-qnftudm7"> <span class="link-title astro-qnftudm7">17. 特性(trait)详解</span> </span> </a> </div>  </footer>  </div> </div>   </main> </div> </div>  </div> </div>  </body></html>